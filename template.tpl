___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Google Conversion Events by Stape",
  "categories": [
    "ADVERTISING",
    "MARKETING",
    "REMARKETING"
  ],
  "brand": {
    "id": "brand_dummy",
    "displayName": "stape.io",
    "thumbnail": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAyAAAAMgCAYAAADbcAZoAAAuDUlEQVR4Ae3df4jf933Y8bdjKY2d5qstaVnSSKOYtYFTN7qubs9zoRkOJxRCC+0Jp+vYH+fJDAbmVAn2x5gU6Y/8Exkd/atY6GClgxiJwsiI8dV/ZKyurildRhff6NaEEV3q0NpudE4kR7Kt3eurfJ2zrB/34/t5fT/vz+fxKMdJiXEaB+zv817v9+t939889vCNAgAAkOB9BQAAIIkAAQAA0ggQAAAgjQABAADSCBAAACCNAAEAANIIEAAAII0AAQAA0ggQAAAgjQABAADSCBAAACCNAAEAANIIEAAAII0AAQAA0ggQAAAgjQABAADSCBAAACCNAAEAANIIEAAAII0AAQAA0ggQAAAgjQABAADSCBAAACCNAAEAANIIEAAAII0AAQAA0ggQAAAgjQABAADSCBAAACCNAAEAANIIEAAAII0AAQAA0ggQAAAgjQABAADSCBAAACCNAAEAANIIEAAAII0AAQAA0ggQAAAgjQABAADSCBAAACCNAAEAANIIEAAAII0AAQAA0ggQAAAgjQABAADSCBAAACCNAAEAANIIEAAAII0AAQAA0ggQAAAgjQABAADSCBAAACCNAAEAANIIEAAAII0AAQAA0ggQAAAgjQABAADSCBAAACCNAAEAANIIEAAAII0AAQAA0ggQAAAgjQABAADSCBAAACCNAAEAANIIEAAAII0AAQAA0ggQAAAgjQABAADSCBAAACCNAAEAANIIEAAAII0AAQAA0ggQAAAgjQABAADSCBAAACCNAAEAANIIEAAAII0AAQAA0ggQAAAgjQABAADSCBAAACDNrsJY/eQLXy0AAHTH337qlwrjYwICAACkESAAAEAaAQIAAKQRIAAAQBoBAgAApBEgAABAGgECAACkESAAAEAaAQIAAKQRIAAAQBoBAgAApBEgAABAGgECAACkESAAAEAaAQIAAKQRIAAAQBoBAgAApBEgAABAGgECAACkESAAAEAaAQIAAKQRIAAAQBoBAgAApBEgAABAGgECAACkESAAAEAaAQIAAKQRIAAAQBoBAgAApBEgAABAGgECAACkESAAAEAaAQIAAKQRIAAAQBoBAgAApBEgAABAGgECAACkESAAAEAaAQIAAKQRIAAAQBoBAgAApBEgAABAGgECAACkESAAAEAaAQIAAKQRIAAAQBoBAgAApBEgAABAGgECAACkESAAAEAaAQIAAKQRIAAAQBoBAgAApBEgAABAGgECAACkESAAAEAaAQIAAKQRIAAAQBoBAgAApBEgAABAGgECAACkESAAAEAaAQIAAKQRIAAAQBoBAgAApBEgAABAGgECAACkESAAAEAaAQIAAKQRIAAAQBoBAgAApBEgAABAGgECAACkESAAAEAaAQIAAKQRIAAAQBoBAgAApBEgAABAGgECAACkESAAAEAaAQIAAKQRIAAAQBoBAgAApBEgAABAGgECAACkESAAAEAaAQIAAKQRIAAAQBoBAgAApBEgAABAGgECAACkESAAAEAaAQIAAKQRIAAAQBoBAgAApBEgAABAGgECAACkESAAAEAaAQIAAKQRIAAAQBoBAgAApBEgAABAGgECAACkESAAAEAaAQIAAKQRIAAAQBoBAgAApBEgAABAGgECAACkESAAAEAaAQIAAKTZVYDJe+rhAjBWv32ilF/+TAFoGxMQAAAgjQABAADSCBAAACCNAAEAANIIEAAAII0AAQAA0ggQAAAgjQABAADSCBAAACCNAAEAANIIEAAAII0AAQAA0ggQAAAgjQABAADSCBAAACCNAAEAANIIEAAAII0AAQAA0ggQAAAgjQABAADSCBAAACCNAAEAANIIEAAAII0AAYAu+plfKABtJEAAoGs++dlSPvxTBaCNBAgAdMmHP7YeIL9VANpKgABAlxx80vQDaDUBAgBd8fGfLeWXP1MA2kyAAEBXHP5CAWg7AQIAXeDiOVAJAQIAtXPxHKiIAAGA2rl4DlREgABAzVw8ByojQACgZi6eA5URIABQKxfPgQoJEACokYvnQKUECADUyMVzoFICBABq4+I5UDEBAgC1cfEcqJgAAYCauHgOVE6AAEAtXDwHOkCAAEAtXDwHOkCAAEANXDwHOkKAAEANXDwHOkKAAEDbuXgOdIgAAYA2c/Ec6BgBAgBt5uI50DECBADaysVzoIMECAC0lYvnQAftKgBA+/zw4vnq6urwt/F99OvLa5fL2traPf8Ug8Gg7BnsGX4ffe3du3f4HWBSBAgATNDamzfK6pW3ysrlN8ul9e+rV94uK2vXy9qLv19Wf+d3SxM2hsj+qf3l43s/Pvw+NTUlToDGCRAASBKxEaHx0vrX8qvXhr+O+Li9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EAAAII0AAQAA0ggQAAAgjQABAADSCBAAACCNAAEAANIIEAAAII0AAQAA0ggQAAAgjQABAADSCBAAACCNAAEAANIIEAAAII0AAQAA0ggQAAAgjQABAADSCBAAACCNAAEAANIIEAAAII0AAQAA0ggQAAAgjQABAADSCBAAACCNAAEAANIIEAAAII0AAQAA0ggQAAAgjQABAADSCBAAACCNAAEAANIIEAAAII0AAQAA0ggQAAAgjQABAADSCBAAACCNAAEAANIIEAAAII0AAQAA0ggQAAAgjQABAADSCBAAACCNAAEAANIIEAAAII0AAQAA0ggQAAAgjQABAADSCBAAACCNAAEAANIIEAAAII0AAQAA0ggQAAAgjQABAADSCBAAACCNAAEAANIIEAAAII0AAQAA0ggQAAAgjQABAADSCBAAACCNAAEAANIIEAAAII0AAQAA0ggQAAAgjQABAADSCBAAACCNAAEAANIIEAAAII0AAQAA0ggQAAAgjQABAADSCBAAACCNAAEAANIIEAAAII0AAQAA0ggQAAAgjQABAADSCBAAACCNAAEAANIIEAAAII0AAQAA0ggQAAAgjQABAADSCBAAACCNAAEAANIIEAAAII0AAQAA0ggQAAAgjQABAADSCBAAACCNAAEAANIIEAAAII0AAQAA0ggQAAAgjQABAADSCBAAACCNAAEAANIIEAAAII0AAQAA0ggQAAAgjQABAADS3PeLX/zNGwUAYAwG3/hPBeBuTEAAAIA0AgQAAEgjQAAAgDQCBAAASCNAAACANAIEAABII0AAAIA0AgQAAEgjQAAAgDQCBAAASCNAAACANAIEAABII0AAAIA0AgQAAEgjQAAAgDQCBAAASCNAAACANAIEAABII0AAAIA0AgQAAEgjQAAAgDQCBAAASCNAAACANAIEAABII0AAAIA0AgQAAEgjQAAAgDQCBAAASCNAAACANAIEAABII0AAAIA0AgQAAEgjQAAAgDQCBAAASCNAAACANAIEAABII0AAAIA0AgQAAEgjQAAAgDQCBAAASCNAAACANAIEAABII0AAAIA0AgQAAEgjQAAAgDQCBAAASCNAAACANAIEAABII0AAAIA0AgQAAEgjQAAAgDQCBAAASCNAAACANAIEAABII0AAAIA0AgQAAEgjQAAAgDQCBAAASCNAAACANAIEAABII0AAAIA0AgQAAEgjQAAAgDQCBAAASCNAAACANAIEAABII0AAAIA0AgQAAEgjQAAAgDQCBAAASCNAAACANAIEAABII0AAAIA0AgQAAEgjQAAAgDQCBAAASCNAAACANAIEAABII0AAAIA0AgQAAEgjQAAAgDQCBAAASCNAAACANP8fZQNTrZqrzswAAAAASUVORK5CYII\u003d"
  },
  "description": "Tag that sends conversion events to Google\u0027s advertising platforms using the Data Manager API.",
  "containerContexts": [
    "SERVER"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "RADIO",
    "name": "authFlow",
    "displayName": "Authentication Type",
    "radioItems": [
      {
        "value": "stape",
        "displayValue": "Stape Google Connection",
        "help": "You can enable it on the Stape container settings, in the \u003ca href\u003d\"https://app.stape.io/container/\" target\u003d\"_blank\"\u003eConnections\u003c/a\u003e section.\n\u003c/br\u003e\u003c/br\u003e\n\u003ca href\u003d\"https://stape.io/solutions/data-manager-api-connection\" target\u003d\"_blank\"\u003eLearn more here.\u003c/a\u003e",
        "subParams": []
      }
    ],
    "simpleValueType": true,
    "defaultValue": "stape"
  },
  {
    "type": "GROUP",
    "name": "destinationsGroup",
    "displayName": "",
    "subParams": [
      {
        "type": "SIMPLE_TABLE",
        "name": "stapeAuthDestinationsList",
        "displayName": "Destination Accounts and Conversion Events",
        "simpleTableColumns": [
          {
            "defaultValue": "GOOGLE_ADS",
            "displayName": "Product",
            "name": "product",
            "type": "SELECT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "selectItems": [
              {
                "value": "GOOGLE_ADS",
                "displayValue": "Google Ads"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Operating Customer ID",
            "name": "operatingAccountId",
            "type": "TEXT",
            "valueHint": "1234567890",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              },
              {
                "type": "POSITIVE_NUMBER"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Customer ID",
            "name": "linkedAccountId",
            "type": "TEXT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              },
              {
                "type": "POSITIVE_NUMBER"
              }
            ],
            "valueHint": "1234567890"
          },
          {
            "defaultValue": "",
            "displayName": "Conversion Event ID",
            "name": "productDestinationId",
            "type": "TEXT",
            "valueHint": "1234567890",
            "isUnique": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "enablingConditions": [
          {
            "paramName": "authFlow",
            "paramValue": "stape",
            "type": "EQUALS"
          }
        ],
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "newRowButtonText": "Add Conversion Event",
        "help": "\u003cb\u003eProduct\u003c/b\u003e: The Product the Conversion belongs to.\n\u003cbr/\u003e\u003cbr/\u003e\n\u003cb\u003eOperating Customer ID\u003c/b\u003e: The \u003ci\u003eAccount ID\u003c/i\u003e (without hyphens) of the account (Google Ads account, DV360 account etc.) that will receive the conversion events. \u003ca href\u003d\"https://developers.google.com/data-manager/api/reference/rest/v1/Destination\"\u003eLearn more\u003c/a\u003e.\n\u003cbr/\u003e\u003cbr/\u003e\n\u003cb\u003eCustomer ID\u003c/b\u003e: The \u003ci\u003eAccount ID\u003c/i\u003e (without hyphens) of the account for which the link between the Data Partner account (Stape) and the Advertiser account was established.\n\u003cbr/\u003e\ne.g. the link between the Data Partner account (Stape) and Advertiser account can be done at MCC level, but the data is going to be sent to a subaccount of the MCC.\n\u003cbr/\u003e\nIn this case: the \u003ci\u003eCustomer Account\u003c/i\u003e is the MCC, and \u003ci\u003eOperating Customer Account\u003c/i\u003e is the subaccount.\n\u003cbr/\u003e\nIf the link is done with the same account that will receive the data, then the \u003ci\u003eCustomer Account\u003c/i\u003e and \u003ci\u003eOperating Customer Account\u003c/i\u003e are the same.\n\u003cbr/\u003e\n\u003ca href\u003d\"https://developers.google.com/data-manager/api/reference/rest/v1/Destination\"\u003eLearn more\u003c/a\u003e.\n\u003cbr/\u003e\u003cbr/\u003e\n\u003cb\u003eConversion Event ID\u003c/b\u003e: The ID of the conversion you want to interact with.\n\u003cbr/\u003e\nYou can find it by going to the \u003ci\u003eGoogle Ads account \u003e Goals \u003e Conversions \u003e Summary \u003e Access the desired Conversion Action\u003c/i\u003e. After you click on the Conversion Action, the ID is on the \u003cb\u003ectId\u003c/b\u003e URL query parameter on your browser.\n\u003cbr/\u003e"
      },
      {
        "type": "SIMPLE_TABLE",
        "name": "ownAuthDestinationsList",
        "displayName": "Destination Accounts and Conversion Events",
        "simpleTableColumns": [
          {
            "defaultValue": "GOOGLE_ADS",
            "displayName": "Product",
            "name": "product",
            "type": "SELECT",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "selectItems": [
              {
                "value": "GOOGLE_ADS",
                "displayValue": "Google Ads"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Operating Customer ID",
            "name": "operatingAccountId",
            "type": "TEXT",
            "valueHint": "1234567890",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              },
              {
                "type": "POSITIVE_NUMBER"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Customer ID",
            "name": "loginAccountId",
            "type": "TEXT",
            "valueHint": "1234567890",
            "valueValidators": []
          },
          {
            "defaultValue": "",
            "displayName": "Conversion Event ID",
            "name": "productDestinationId",
            "type": "TEXT",
            "valueHint": "1234567890",
            "isUnique": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "enablingConditions": [
          {
            "paramName": "authFlow",
            "paramValue": "own",
            "type": "EQUALS"
          }
        ],
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "newRowButtonText": "Add Conversion Event",
        "help": "\u003cb\u003eProduct\u003c/b\u003e: The Product the Conversion belongs to.\n\u003cbr/\u003e\u003cbr/\u003e\n\u003cb\u003eOperating Customer ID\u003c/b\u003e: The \u003ci\u003eAccount ID\u003c/i\u003e (without hyphens) of the account (Google Ads account, DV360 account etc.) that will receive the conversion events. \u003ca href\u003d\"https://developers.google.com/data-manager/api/reference/rest/v1/Destination\"\u003eLearn more\u003c/a\u003e.\n\u003cbr/\u003e\u003cbr/\u003e\n\u003cb\u003eCustomer ID\u003c/b\u003e: The \u003ci\u003eAccount ID\u003c/i\u003e of the account (Google Ads account, DV360 account etc.) used for authorization (without hyphens) when making the API request.\n\u003cbr/\u003e\nIf your credentials are for access to a \u003ci\u003eManager Account\u003c/i\u003e that has the \u003ci\u003eOperating Account\u003c/i\u003e as one of its subaccounts, set the \u003ci\u003eCustomer ID\u003c/i\u003e to the ID of the \u003ci\u003eManager Account\u003c/i\u003e.\n\u003cbr/\u003e\nIf your credentials are for the account that is the \u003ci\u003eOperating Account\u003c/i\u003e, you don\u0027t need to set \u003ci\u003eCustomer ID\u003c/i\u003e.\n\u003cbr/\u003e\nLearn more: \u003ca href\u003d\"https://developers.google.com/data-manager/api/reference/rest/v1/Destination\"\u003e[1]\u003c/a\u003e and \u003ca href\u003d\"https://developers.google.com/data-manager/api/get-started/quickstart/send-events?persona\u003dadvertiser#prepare_a_destination\"\u003e[2]\u003c/a\u003e.\n\u003cbr/\u003e\u003cbr/\u003e\n\u003cb\u003eConversion Event ID\u003c/b\u003e: The ID of the conversion you want to interact with.\n\u003cbr/\u003e\nYou can find it by going to the \u003ci\u003eGoogle Ads account \u003e Goals \u003e Conversions \u003e Summary \u003e Access the desired Conversion Action\u003c/i\u003e. After you click on the Conversion Action, the ID is on the \u003cb\u003ectId\u003c/b\u003e URL query parameter on your browser.\n\u003cbr/\u003e"
      }
    ],
    "groupStyle": "NO_ZIPPY"
  },
  {
    "type": "SELECT",
    "name": "validateOnly",
    "displayName": "Validate Only",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": true,
        "displayValue": "true"
      },
      {
        "value": false,
        "displayValue": "false"
      }
    ],
    "simpleValueType": true,
    "help": "If \u003cb\u003etrue\u003c/b\u003e, the request is validated but not executed. Only errors are returned, not results.\u003cbr /\u003e \u003ca href\u003d\"https://developers.google.com/data-manager/api/reference/rest/v1/events/ingest#request-body\"\u003eLearn more\u003c/a\u003e.",
    "defaultValue": false
  },
  {
    "type": "SELECT",
    "name": "useOptimisticScenario",
    "displayName": "Use Optimistic Scenario",
    "macrosInSelect": true,
    "selectItems": [
      {
        "value": true,
        "displayValue": "true"
      },
      {
        "value": false,
        "displayValue": "false"
      }
    ],
    "simpleValueType": true,
    "help": "The tag will call gtmOnSuccess() without waiting for a response from the API. This will speed up sGTM response time however your tag will always return the status fired successfully even in case it is not.",
    "defaultValue": false
  },
  {
    "type": "GROUP",
    "name": "requestLevelConsentGroup",
    "displayName": "Request-level Consent",
    "groupStyle": "ZIPPY_OPEN_ON_PARAM",
    "subParams": [
      {
        "type": "LABEL",
        "name": "requestLevelConsentGroupLabel",
        "displayName": "Request-level consent to apply to all users in the request.\n\u003cbr/\u003e\nUser-level consent overrides request-level consent, and can be specified for each conversion event when sending data to \u003ci\u003eMultiple Conversion Events\u003c/i\u003e in the \u003cb\u003eConversion Events\u003c/b\u003e section."
      },
      {
        "type": "SELECT",
        "name": "adUserData",
        "displayName": "Consent for Ad User Data",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "CONSENT_GRANTED",
            "displayValue": "CONSENT_GRANTED"
          },
          {
            "value": "CONSENT_DENIED",
            "displayValue": "CONSENT_DENIED"
          },
          {
            "value": "CONSENT_STATUS_UNSPECIFIED",
            "displayValue": "CONSENT_STATUS_UNSPECIFIED"
          }
        ],
        "simpleValueType": true,
        "help": "This represents consent to Ad User Data.",
        "notSetText": "(not set)"
      },
      {
        "type": "SELECT",
        "name": "adPersonalization",
        "displayName": "Consent for Ad Personalization",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "CONSENT_GRANTED",
            "displayValue": "CONSENT_GRANTED"
          },
          {
            "value": "CONSENT_DENIED",
            "displayValue": "CONSENT_DENIED"
          },
          {
            "value": "CONSENT_STATUS_UNSPECIFIED",
            "displayValue": "CONSENT_STATUS_UNSPECIFIED"
          }
        ],
        "simpleValueType": true,
        "help": "This represents consent to Ad Personalization.",
        "notSetText": "(not set)"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "conversionEventsGroup",
    "displayName": "Conversion Events",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "SELECT",
        "name": "userDataEncoding",
        "displayName": "User Data Encoding",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": "HEX",
            "displayValue": "HEX"
          },
          {
            "value": "BASE64",
            "displayValue": "BASE64"
          }
        ],
        "simpleValueType": true,
        "help": "The encoding type of the user identifiers SHA256 hash: \u003ci\u003eHEX\u003c/i\u003e or \u003ci\u003eBASE64\u003c/i\u003e.\n\u003cbr/\u003e\u003cbr/\u003e\n\u003cb\u003eRequired\u003c/b\u003e for \u003ca href\u003d\"https://developers.google.com/data-manager/api/reference/rest/v1/UserData\"\u003e\u003ci\u003eUserData\u003c/i\u003e\u003c/a\u003e (User Email Address, User Phone Number and User Given/Family Name) uploads.\n\u003cbr/\u003e\nFor other types (User Address Region and User Address Postal Code) uploads, this field is \u003cb\u003eignored\u003c/b\u003e.\n\u003cbr/\u003e\u003cbr/\u003e\nFor hashed user identifiers, this is the encoding type of the hashed string. \n\u003cbr/\u003e\nFor encrypted hashed user identifiers, this is the encoding type of the outer encrypted string, but not necessarily the inner hashed string, meaning the inner hashed string could be encoded in a different way than the outer encrypted string.\n\u003cbr/\u003e\u003cbr/\u003e\n\u003cb\u003eDefault\u003c/b\u003e: \u003ci\u003eHEX\u003c/i\u003e - when passing a non-hashed value to \u003ci\u003eUserData\u003c/i\u003e (User Email Address, User Phone Number and User Given/Family Name) fields; or when using default values from GA4 Event Data.",
        "notSetText": "(not set)"
      },
      {
        "type": "SELECT",
        "name": "enableUserDataEncryption",
        "displayName": "User Data Encryption",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": false,
            "displayValue": "false"
          },
          {
            "value": true,
            "displayValue": "true"
          }
        ],
        "simpleValueType": true,
        "help": "Encryption information for \u003ca href\u003d\"https://developers.google.com/data-manager/api/reference/rest/v1/UserData\"\u003e\u003ci\u003eUserData\u003c/i\u003e\u003c/a\u003e (User Email Address, User Phone Number and User Given/Family Name) uploads.\n\u003cbr/\u003e\u003cbr/\u003e\nIf not set, it\u0027s assumed that uploaded identifying information is hashed but not encrypted.\n\u003cbr/\u003e\u003cbr/\u003e \nFor other types (User Address Region and User Address Postal Code) uploads, this field is \u003cb\u003eignored\u003c/b\u003e.\n\u003cbr/\u003e\u003cbr/\u003e\nReferences:  \n\u003cul\u003e \n\u003cli\u003e\u003ca href\u003d\"https://developers.google.com/data-manager/api/get-started/encryption\"\u003eData Manager API: Getting started with Encryption\u003c/a\u003e\u003c/li\u003e \u003cli\u003e\u003ca href\u003d\"https://developers.google.com/data-manager/api/reference/rest/v1/EncryptionInfo\"\u003eEncryptionInfo object\u003c/a\u003e\u003c/li\u003e \u003c/ul\u003e",
        "defaultValue": false,
        "subParams": [
          {
            "type": "GROUP",
            "name": "userDataEncryptionInfoGroup",
            "displayName": "Encryption Info (Google Cloud Platform wrapped key information)",
            "groupStyle": "ZIPPY_OPEN_ON_PARAM",
            "subParams": [
              {
                "type": "SELECT",
                "name": "gcpWrappedKeyType",
                "displayName": "Key Type",
                "macrosInSelect": false,
                "selectItems": [
                  {
                    "value": "XCHACHA20_POLY1305",
                    "displayValue": "XCHACHA20_POLY1305"
                  }
                ],
                "simpleValueType": true,
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  }
                ],
                "help": "The type of algorithm used to encrypt the data."
              },
              {
                "type": "TEXT",
                "name": "gcpWrappedKeyWipProvider",
                "displayName": "Workload Identity pool provider",
                "simpleValueType": true,
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  }
                ],
                "help": "The \u003ca href\u003d\"https://cloud.google.com/iam/docs/workload-identity-federation\"\u003eWorkload Identity\u003c/a\u003e pool provider required to use KEK."
              },
              {
                "type": "TEXT",
                "name": "gcpWrappedKeyKekUri",
                "displayName": "Google Cloud Platform Cloud Key Management Service resource ID",
                "simpleValueType": true,
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  }
                ],
                "help": "The Google Cloud Platform \u003ca href\u003d\"https://cloud.google.com/kms/docs/getting-resource-ids\"\u003eCloud Key Management Service resource ID\u003c/a\u003e."
              },
              {
                "type": "TEXT",
                "name": "gcpWrappedKeyEncryptedDek",
                "displayName": "Encrypted data encryption key",
                "simpleValueType": true,
                "help": "The base64 encoded encrypted data encryption key.",
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  }
                ]
              }
            ],
            "enablingConditions": [
              {
                "paramName": "enableUserDataEncryption",
                "paramValue": false,
                "type": "NOT_EQUALS"
              }
            ]
          }
        ]
      },
      {
        "type": "SELECT",
        "name": "conversionEventMode",
        "displayName": "Conversion Event Mode",
        "macrosInSelect": false,
        "selectItems": [
          {
            "value": "single",
            "displayValue": "Single Conversion Event"
          },
          {
            "value": "multiple",
            "displayValue": "Multiple Conversion Events"
          }
        ],
        "simpleValueType": true,
        "help": "Send data for a single conversion event or for multiple conversion events."
      },
      {
        "type": "GROUP",
        "name": "conversionEventsMultipleGroup",
        "subParams": [
          {
            "type": "TEXT",
            "name": "conversionEvents",
            "displayName": "Conversion Events Array",
            "simpleValueType": true,
            "help": "Specify the Conversion Events array. This is useful when you need to upload data for multiple conversion events at once. At most 2000 Conversion Events can be specified in the array.\n\u003cbr/\u003e\u003cbr/\u003e\nThe array must be formatted as specified in the\nGoogle Documentation. You can specify different consent types for each Conversion Event, overriding the request-level consent.\n\u003cbr/\u003e\u003cbr/\u003e\n\u003cb\u003eIf you already pass SHA256 hashed fields to \u003ca href\u003d\"https://developers.google.com/data-manager/api/reference/rest/v1/UserData\"\u003e\u003ci\u003eUserData\u003c/i\u003e\u003c/a\u003e field, make sure to specify the SHA256 hash encoding in the corresponding template field. Otherwise, the tag will hash it automatically and set it for you.\u003c/b\u003e\n\u003cbr/\u003e\u003cbr/\u003e\nWhen working with multiple Conversion Event IDs, you can direct an event to a specific subset of them. To do so, list the desired Conversion Event IDs in the \u003ca target\u003d\"https://developers.google.com/data-manager/api/reference/rest/v1/events/ingest#event\"\u003e\u003ci\u003edestinationReferences\u003c/i\u003e\u003c/a\u003e array.\n\u003cbr/\u003e\u003cbr/\u003e\nReferences: \n\u003cul\u003e\n\u003cli\u003e\u003ca href\u003d\"https://developers.google.com/data-manager/api/reference/rest/v1/events/ingest#Event\"\u003eConversion Event\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href\u003d\"https://developers.google.com/data-manager/api/get-started/formatting\"\u003eNormalization guidelines\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href\u003d\"https://developers.google.com/data-manager/api/get-started/quickstart/send-events?persona\u003dadvertiser#build_the_request_body\"\u003eExample\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "enablingConditions": [
          {
            "paramName": "conversionEventMode",
            "paramValue": "multiple",
            "type": "EQUALS"
          }
        ],
        "groupStyle": "NO_ZIPPY"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "conversionEventsSingleGroup",
    "groupStyle": "NO_ZIPPY",
    "subParams": [
      {
        "type": "GROUP",
        "name": "conversionInformationGroup",
        "displayName": "Conversion Information",
        "groupStyle": "ZIPPY_OPEN_ON_PARAM",
        "subParams": [
          {
            "type": "SELECT",
            "name": "autoMapConversionInformation",
            "displayName": "Auto-map Conversion Information",
            "macrosInSelect": true,
            "selectItems": [
              {
                "value": true,
                "displayValue": "true"
              },
              {
                "value": false,
                "displayValue": "false"
              }
            ],
            "simpleValueType": true,
            "help": "If enabled, the tag will attempt to automatically map parameters from the Event Data.\n\u003cbr/\u003e\u003cbr/\u003e\nAny value you manually enter in a field below will always override the auto-mapped value.\n\u003cbr/\u003e\u003cbr/\u003e\nDefault mappings:\n\u003cul\u003e\n\u003cli\u003eTransaction/Order ID: \u003ci\u003eeventData.transaction_id\u003c/i\u003e\u003c/li\u003e\n\u003cli\u003eCurrency: \u003ci\u003eeventData.currency\u003c/i\u003e\n\u003cli\u003eConversion Value: \u003ci\u003eeventData.value\u003c/i\u003e \u003e Sum of \u003ci\u003eeventData.items Price * Quantity\u003c/i\u003e\u003c/li\u003e\n\u003c/ul\u003e",
            "defaultValue": true
          },
          {
            "type": "SELECT",
            "name": "eventSource",
            "displayName": "Event Source",
            "macrosInSelect": true,
            "selectItems": [
              {
                "value": "WEB",
                "displayValue": "WEB"
              },
              {
                "value": "APP",
                "displayValue": "APP"
              },
              {
                "value": "IN_STORE",
                "displayValue": "IN_STORE"
              },
              {
                "value": "PHONE",
                "displayValue": "PHONE"
              },
              {
                "value": "OTHER",
                "displayValue": "OTHER"
              }
            ],
            "simpleValueType": true,
            "help": "\u003cb\u003eRequired.\u003c/b\u003e\n\u003cbr/\u003e\u003cbr/\u003e\nA signal for where the event happened originally (web, app, in-store, etc.).",
            "notSetText": "(not set)",
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "transactionId",
            "displayName": "Transaction/Order ID",
            "simpleValueType": true,
            "help": "\u003cb\u003eRequired.\u003c/b\u003e\n\u003cbr/\u003e\u003cbr/\u003e\nThe unique identifier for this event."
          },
          {
            "type": "TEXT",
            "name": "eventTimestamp",
            "displayName": "Event Timestamp",
            "simpleValueType": true,
            "help": "\u003cb\u003eRequired.\u003c/b\u003e\n\u003cbr/\u003e\u003cbr/\u003e\nThe time the event occurred.\n\u003cbr/\u003e\u003cbr/\u003e\nThe supported formats are:\n\u003cul\u003e \n\u003cli\u003eRFC 3339 compliant formats:\n\u003cul\u003e\n\u003cli\u003e2014-10-02T15:01:23Z\u003c/li\u003e\n\u003cli\u003e2014-10-02T15:01:23.045123456Z\u003c/li\u003e\n\u003cli\u003e2014-10-02T15:01:23+05:30\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e \n\u003cli\u003eUnix timestamp (in seconds or milliseconds)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cbr/\u003e\nIf not set, the tag will fallback to the current time if none is found."
          },
          {
            "type": "TEXT",
            "name": "lastUpdatedTimestamp",
            "displayName": "Last Updated Timestamp",
            "simpleValueType": true,
            "help": "The last time the event was updated.\n\u003cbr/\u003e\u003cbr/\u003e\nThe supported formats are:\n\u003cul\u003e \n\u003cli\u003eRFC 3339 compliant formats:\n\u003cul\u003e\n\u003cli\u003e2014-10-02T15:01:23Z\u003c/li\u003e\n\u003cli\u003e2014-10-02T15:01:23.045123456Z\u003c/li\u003e\n\u003cli\u003e2014-10-02T15:01:23+05:30\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e \n\u003cli\u003eUnix timestamp (in seconds or milliseconds)\u003c/li\u003e\n\u003c/ul\u003e"
          },
          {
            "type": "TEXT",
            "name": "currency",
            "displayName": "Currency",
            "simpleValueType": true,
            "help": "The currency code associated with all monetary values within this event.\n\u003cbr/\u003e\u003cbr/\u003e\nThe value must be a recognized currency code as per \u003ca href\u003d\"http://en.wikipedia.org/wiki/ISO_4217\"\u003eISO-4217 standard\u003c/a\u003e (e.g. EUR, USD, etc.)."
          },
          {
            "type": "TEXT",
            "name": "conversionValue",
            "displayName": "Conversion Value",
            "simpleValueType": true,
            "help": "The conversion value associated with the event, for value-based conversions."
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "userDataGroup",
        "displayName": "User Data",
        "groupStyle": "ZIPPY_OPEN_ON_PARAM",
        "subParams": [
          {
            "type": "LABEL",
            "name": "userDataGroupLabel",
            "displayName": "When sending User Data Identifiers, \u003cb\u003eat least one\u003c/b\u003e of User Email Address(es), User Phone Number(s) or User Address must be specified.\n\u003cbr/\u003e\nThe total number of User Data identifiers must not exceed 10 items."
          },
          {
            "type": "SELECT",
            "name": "autoMapUserData",
            "displayName": "Auto-map Conversion Information",
            "macrosInSelect": true,
            "selectItems": [
              {
                "value": true,
                "displayValue": "true"
              },
              {
                "value": false,
                "displayValue": "false"
              }
            ],
            "simpleValueType": true,
            "help": "If enabled, the tag will attempt to automatically map parameters from the Event Data.\n\u003cbr/\u003e\u003cbr/\u003e\nAny value you manually enter in a field below will always override the auto-mapped value.\n\u003cbr/\u003e\u003cbr/\u003e\nDefault mappings:\n\u003cul\u003e\n\u003cli\u003eEmail: \u003ci\u003eeventData.email\u003c/i\u003e \u003e \u003ci\u003eeventData.email_address\u003c/i\u003e \u003e \u003ci\u003eeventData.user_data.email\u003c/i\u003e \u003e \u003ci\u003eeventData.user_data.email_address\u003c/i\u003e \u003e \u003ci\u003eeventData.user_data.sha256_email_address\u003c/i\u003e\u003c/li\u003e\n\u003cli\u003ePhone: \u003ci\u003eeventData.phone\u003c/i\u003e \u003e \u003ci\u003eeventData.phone_number\u003c/i\u003e \u003e \u003ci\u003eeventData.user_data.phone\u003c/i\u003e \u003e \u003ci\u003eeventData.user_data.phone_number\u003c/i\u003e \u003e \u003ci\u003eeventData.user_data.sha256_phone_number\u003c/i\u003e\u003c/li\u003e\n\u003cli\u003eUser Given Name: \u003ci\u003eeventData.user_data.address.first_name\u003c/i\u003e \u003e \u003ci\u003eeventData.user_data.address.sha256_first_name\u003c/i\u003e\u003c/li\u003e\n\u003cli\u003eUser Family Name: \u003ci\u003eeventData.user_data.address.last_name\u003c/i\u003e \u003e \u003ci\u003eeventData.user_data.address.sha256_last_name\u003c/i\u003e\u003c/li\u003e\n\u003cli\u003eUser Address Region: \u003ci\u003eeventData.user_data.address.country\u003c/i\u003e\u003c/li\u003e\n\u003cli\u003eUser Address Postal Code: \u003ci\u003eeventData.user_data.address.postal_code\u003c/i\u003e\u003c/li\u003e\n\n\u003c/ul\u003e",
            "defaultValue": true
          },
          {
            "type": "TEXT",
            "name": "userDataEmailAddresses",
            "displayName": "User Email Address(es)",
            "simpleValueType": true,
            "help": "Specify a single email address, or an array of email addresses. Each item can be already SHA256 hashed or not. They can be already encrypted as well.\n\u003cbr/\u003e\u003cbr/\u003e\nIf already SHA256 hashed, make sure to follow these \u003ca href\u003d\"https://developers.google.com/data-manager/api/get-started/formatting#userdata_format\"\u003enormalization guidelines\u003c/a\u003e before applying the hash, and also to \u003cb\u003especify the hash encoding in the corresponding template field\u003c/b\u003e.",
            "valueHint": "jane@example.com"
          },
          {
            "type": "TEXT",
            "name": "userDataPhoneNumbers",
            "displayName": "User Phone Number(s)",
            "simpleValueType": true,
            "help": "Specify a single phone number, or an array of phone numbers. Each item can be already SHA256 hashed or not. They can be already encrypted as well.\n\u003cbr/\u003e\u003cbr/\u003e\nUse \u003ca href\u003d\"https://en.wikipedia.org/wiki/E.164\"\u003eE.164 format\u003c/a\u003e. Include the plus sign (+) and the country code.\n\u003cbr/\u003e\nIf already SHA256 hashed, make sure to follow these \u003ca href\u003d\"https://developers.google.com/data-manager/api/get-started/formatting#userdata_format\"\u003enormalization guidelines\u003c/a\u003e before applying the hash, and also to \u003cb\u003especify the hash encoding in the corresponding template field\u003c/b\u003e.",
            "valueHint": "+1555999999999"
          },
          {
            "type": "CHECKBOX",
            "name": "addUserDataAddress",
            "checkboxText": "Add User Address data",
            "simpleValueType": true,
            "subParams": [
              {
                "type": "GROUP",
                "name": "userDataAddressGroup",
                "subParams": [
                  {
                    "type": "LABEL",
                    "name": "userDataAddressLabel",
                    "displayName": "You must specify \u003cb\u003eall\u003c/b\u003e the fields below (User Given Name, User Family Name, User Address Region and User Address Postal Code)."
                  },
                  {
                    "type": "TEXT",
                    "name": "userDataAddressGivenName",
                    "displayName": "User Given Name",
                    "simpleValueType": true,
                    "help": "Specify the User Given Name (First Name). Don\u0027t include prefixes such as \u003ci\u003eMrs.\u003c/i\u003e. It can be already SHA256 hashed or not. It can be encrypted as well.\n\u003cbr/\u003e\u003cbr/\u003e\nIf already SHA256 hashed, make sure to follow these \u003ca href\u003d\"https://developers.google.com/data-manager/api/get-started/formatting#userdata_format\"\u003enormalization guidelines\u003c/a\u003e before applying the hash, and also to \u003cb\u003especify the hash encoding in the corresponding template field\u003c/b\u003e.",
                    "valueHint": "john",
                    "valueValidators": []
                  },
                  {
                    "type": "TEXT",
                    "name": "userDataAddressFamilyName",
                    "displayName": "User Family Name",
                    "simpleValueType": true,
                    "help": "Specify the User Family Name (Last Name). Don\u0027t include suffixes such as \u003ci\u003eJr\u003c/i\u003e. It can be already SHA256 hashed or not. It can be encrypted as well.\n\u003cbr/\u003e\u003cbr/\u003e\nIf already SHA256 hashed, make sure to follow these \u003ca href\u003d\"https://developers.google.com/data-manager/api/get-started/formatting#userdata_format\"\u003enormalization guidelines\u003c/a\u003e before applying the hash, and also to \u003cb\u003especify the hash encoding in the corresponding template field\u003c/b\u003e.",
                    "valueHint": "doe",
                    "valueValidators": []
                  },
                  {
                    "type": "TEXT",
                    "name": "userDataAddressRegion",
                    "displayName": "User Address Region",
                    "simpleValueType": true,
                    "help": "The 2-letter region code in \u003ca href\u003d\"https://en.wikipedia.org/wiki/ISO_3166-1_alpha-2\"\u003eISO-3166-1 alpha-2\u003c/a\u003e of the user\u0027s address. Do not hash.",
                    "valueHint": "US",
                    "valueValidators": []
                  },
                  {
                    "type": "TEXT",
                    "name": "userDataAddressPostalCode",
                    "displayName": "User Address Postal Code",
                    "simpleValueType": true,
                    "help": "The postal code of the user\u0027s address. Do not hash.\n\u003cbr/\u003e\nBoth US and international zip and postal codes are allowed. \n\u003cbr/\u003e\nFor US addresses, use either 5 digits or 5 digits followed by a 4-digit extension. Using a 4-digit extension may improve your match rate.\n\u003cbr/\u003e\nFor all other countries, don\u0027t use postal code extensions.",
                    "valueHint": "10001",
                    "valueValidators": []
                  }
                ],
                "enablingConditions": [
                  {
                    "paramName": "addUserDataAddress",
                    "paramValue": true,
                    "type": "EQUALS"
                  }
                ],
                "groupStyle": "NO_ZIPPY"
              }
            ]
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "adIdentifiersGroup",
        "displayName": "Ad Identifiers",
        "groupStyle": "ZIPPY_OPEN_ON_PARAM",
        "subParams": [
          {
            "type": "TEXT",
            "name": "adIdentifiersGclid",
            "displayName": "gclid",
            "simpleValueType": true,
            "help": "The Google Click ID (\u003ci\u003egclid\u003c/i\u003e) associated with this event."
          },
          {
            "type": "TEXT",
            "name": "adIdentifiersGbraid",
            "displayName": "gbraid",
            "simpleValueType": true,
            "help": "The click identifier for clicks associated with app events and originating from iOS devices starting with iOS14."
          },
          {
            "type": "TEXT",
            "name": "adIdentifiersWbraid",
            "displayName": "wbraid",
            "simpleValueType": true,
            "help": "The click identifier for clicks associated with web events and originating from iOS devices starting with iOS14."
          },
          {
            "type": "TEXT",
            "name": "adIdentifiersLandingPageDeviceInfoUserAgent",
            "displayName": "Landing Page User Agent",
            "simpleValueType": true,
            "help": "Information gathered about the device\u0027s user agent being used (if any) at the time of landing onto the advertiser’s site after interacting with the ad."
          },
          {
            "type": "TEXT",
            "name": "adIdentifiersLandingPageDeviceInfoIpAddress",
            "displayName": "Landing Page IP Address",
            "simpleValueType": true,
            "help": "Information gathered about the device\u0027s IP address being used (if any) at the time of landing onto the advertiser’s site after interacting with the ad."
          },
          {
            "type": "TEXT",
            "name": "adIdentifiersSessionAttributes",
            "displayName": "Session Attributes",
            "simpleValueType": true,
            "help": "Session attributes for event attribution and modeling."
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "eventDeviceInfoGroup",
        "displayName": "Event Device Information",
        "groupStyle": "ZIPPY_OPEN_ON_PARAM",
        "subParams": [
          {
            "type": "SELECT",
            "name": "autoMapEventDeviceInfo",
            "displayName": "Auto-map Event Device Information",
            "macrosInSelect": true,
            "selectItems": [
              {
                "value": true,
                "displayValue": "true"
              },
              {
                "value": false,
                "displayValue": "false"
              }
            ],
            "simpleValueType": true,
            "help": "If enabled, the tag will attempt to automatically map parameters from the Event Data.\n\u003cbr/\u003e\u003cbr/\u003e\nAny value you manually enter in a field below will always override the auto-mapped value.\n\u003cbr/\u003e\u003cbr/\u003e\nDefault mappings:\n\u003cul\u003e\n\u003cli\u003eUser Agent: \u003ci\u003eeventData.user_agent\u003c/i\u003e\u003c/li\u003e\n\u003cli\u003eIP Address: \u003ci\u003eeventData.ip_override\u003c/i\u003e\u003c/li\u003e\n\u003c/ul\u003e",
            "defaultValue": true
          },
          {
            "type": "TEXT",
            "name": "eventDeviceInfoUserAgent",
            "displayName": "User Agent",
            "simpleValueType": true,
            "help": "Information gathered about the device\u0027s user agent being used (if any) when the event happened."
          },
          {
            "type": "TEXT",
            "name": "eventDeviceInfoIpAddress",
            "displayName": "IP Address",
            "simpleValueType": true,
            "help": "Information gathered about the device\u0027s IP address being used (if any) when the event happened."
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "userPropertiesGroup",
        "displayName": "User Properties",
        "groupStyle": "ZIPPY_OPEN_ON_PARAM",
        "subParams": [
          {
            "type": "SELECT",
            "name": "userPropertiesCustomerType",
            "displayName": "Customer Type",
            "macrosInSelect": true,
            "selectItems": [
              {
                "value": "NEW",
                "displayValue": "NEW"
              },
              {
                "value": "RETURNING",
                "displayValue": "RETURNING"
              },
              {
                "value": "REENGAGED",
                "displayValue": "REENGAGED"
              }
            ],
            "simpleValueType": true,
            "help": "Type of the customer associated with the event.",
            "notSetText": "(not set)"
          },
          {
            "type": "SELECT",
            "name": "userPropertiesCustomerValueBucket",
            "displayName": "Customer Value Bucket",
            "macrosInSelect": true,
            "selectItems": [
              {
                "value": "LOW",
                "displayValue": "LOW"
              },
              {
                "value": "MEDIUM",
                "displayValue": "MEDIUM"
              },
              {
                "value": "HIGH",
                "displayValue": "HIGH"
              }
            ],
            "simpleValueType": true,
            "help": "The advertiser-assessed value of the customer.",
            "notSetText": "(not set)"
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "cartDataGroup",
        "displayName": "Cart Data",
        "groupStyle": "ZIPPY_OPEN_ON_PARAM",
        "subParams": [
          {
            "type": "SELECT",
            "name": "autoMapCartData",
            "displayName": "Auto-map Cart Data",
            "macrosInSelect": true,
            "selectItems": [
              {
                "value": true,
                "displayValue": "true"
              },
              {
                "value": false,
                "displayValue": "false"
              }
            ],
            "simpleValueType": true,
            "help": "If enabled, the tag will attempt to automatically map parameters from the Event Data.\n\u003cbr/\u003e\u003cbr/\u003e\nAny value you manually enter in a field below will always override the auto-mapped value.\n\u003cbr/\u003e\u003cbr/\u003e\nDefault mappings:\n\u003cul\u003e\n\u003cli\u003eItems: \u003ci\u003eeventData.items\u003c/i\u003e\u003c/li\u003e\n\u003c/ul\u003e",
            "defaultValue": true,
            "subParams": [
              {
                "type": "TEXT",
                "name": "itemIdKey",
                "displayName": "Custom Item ID Key",
                "simpleValueType": true,
                "help": "Optional. \u003cbr/\u003e\u003cbr/\u003e You can specify a custom key, which will be used to set the content Item ID, by default \u003ci\u003eitem_id\u003c/i\u003e will be used. This may be useful if you are using WooCommerce extensions.",
                "enablingConditions": [
                  {
                    "paramName": "autoMapCartData",
                    "paramValue": false,
                    "type": "NOT_EQUALS"
                  }
                ]
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "cartDataMerchantId",
            "displayName": "Merchant Center ID",
            "simpleValueType": true,
            "help": "The Merchant Center ID associated with the items.\n\u003cbr/\u003e\u003cbr/\u003e\n\u003ca href\u003d\"https://support.google.com/paymentscenter/answer/7163092?hl\u003den\"\u003eLearn more\u003c/a\u003e."
          },
          {
            "type": "TEXT",
            "name": "cartDataMerchantFeedLabel",
            "displayName": "Merchant Center Feed Label",
            "simpleValueType": true,
            "help": "The Merchant Center feed label associated with the feed of the items.\n\u003cbr/\u003e\u003cbr/\u003e\nYou can find it as a URL parameter in the Merchant Center URL:  \u003ci\u003efeedLabel\u003d\u003cb\u003eDK\u003c/b\u003e\u003c/i\u003e."
          },
          {
            "type": "TEXT",
            "name": "cartDataMerchantFeedLanguageCode",
            "displayName": "Merchant Center Feed Language Code",
            "simpleValueType": true,
            "help": "The language code in ISO 639-1 associated with the Merchant Center feed of the items.where your items are uploaded.\n\u003cbr/\u003e\u003cbr/\u003e\nYou can find it as a URL parameter in the Merchant Center URL: \u003ci\u003elanguage\u003d\u003cb\u003eda\u003c/b\u003e\u003c/i\u003e."
          },
          {
            "type": "TEXT",
            "name": "cartDataTransactionDiscount",
            "displayName": "Transaction Discount",
            "simpleValueType": true,
            "help": "The sum of all discounts associated with the transaction/conversion."
          },
          {
            "type": "TEXT",
            "name": "cartDataItems",
            "displayName": "Items",
            "simpleValueType": true,
            "help": "The list of items associated with the event. Each item is an object in the list with the following properties: \u003ci\u003emerchantProductId\u003c/i\u003e, \u003ci\u003equantity\u003c/i\u003e and \u003ci\u003eunitPrice\u003c/i\u003e.\n\u003cbr/\u003e\n\u003ca href\u003d\"https://developers.google.com/data-manager/api/reference/rest/v1/events/ingest#item\"\u003eLearn more\u003c/a\u003e."
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "customVariablesGroup",
        "displayName": "Custom Variables",
        "groupStyle": "ZIPPY_OPEN_ON_PARAM",
        "subParams": [
          {
            "type": "LABEL",
            "name": "customVariablesGroupLabel",
            "displayName": "\u003ca href\u003d\"https://developers.google.com/data-manager/api/reference/rest/v1/events/ingest#customvariable\"\u003eLearn more\u003c/a\u003e about Custom Variables.\n\u003cbr/\u003e\nIn the optional \u003ci\u003eDestination References\u003c/i\u003e column, you may leave it blank, or specify either a single reference or an array of references.\n\u003cbr/\u003e\u003cbr/\u003e"
          },
          {
            "type": "SIMPLE_TABLE",
            "name": "customVariablesList",
            "displayName": "",
            "simpleTableColumns": [
              {
                "defaultValue": "",
                "displayName": "Variable Name",
                "name": "name",
                "type": "TEXT",
                "isUnique": true,
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  }
                ]
              },
              {
                "defaultValue": "",
                "displayName": "Variable Value",
                "name": "value",
                "type": "TEXT",
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  }
                ]
              },
              {
                "defaultValue": "",
                "displayName": "Destination References",
                "name": "destinationReferences",
                "type": "TEXT"
              }
            ],
            "newRowButtonText": "Add Variable"
          }
        ]
      },
      {
        "type": "GROUP",
        "name": "experimentalFieldsGroup",
        "displayName": "Experimental Fields",
        "groupStyle": "ZIPPY_OPEN_ON_PARAM",
        "subParams": [
          {
            "type": "LABEL",
            "name": "experimentalFieldsGroupLabel",
            "displayName": "\u003ca href\u003d\"https://developers.google.com/data-manager/api/reference/rest/v1/events/ingest#experimentalfield\"\u003eLearn more\u003c/a\u003e about Experimental Fields.\n\u003cbr/\u003e\u003cbr/\u003e"
          },
          {
            "type": "SIMPLE_TABLE",
            "name": "experimentalFieldsList",
            "displayName": "",
            "simpleTableColumns": [
              {
                "defaultValue": "",
                "displayName": "Field Name",
                "name": "name",
                "type": "TEXT",
                "isUnique": true,
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  }
                ]
              },
              {
                "defaultValue": "",
                "displayName": "Field Value",
                "name": "value",
                "type": "TEXT",
                "valueValidators": [
                  {
                    "type": "NON_EMPTY"
                  }
                ]
              }
            ],
            "newRowButtonText": "Add Field"
          }
        ]
      }
    ],
    "enablingConditions": [
      {
        "paramName": "conversionEventMode",
        "paramValue": "single",
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "tagExecutionConsentSettingsGroup",
    "displayName": "Tag Execution Consent Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "RADIO",
        "name": "adStorageConsent",
        "displayName": "",
        "radioItems": [
          {
            "value": "optional",
            "displayValue": "Send data always"
          },
          {
            "value": "required",
            "displayValue": "Send data in case marketing consent given",
            "help": "Aborts the tag execution if marketing consent (\u003ci\u003ead_storage\u003c/i\u003e Google Consent Mode or Stape\u0027s Data Tag parameter) is not given."
          }
        ],
        "simpleValueType": true,
        "defaultValue": "optional"
      }
    ]
  },
  {
    "displayName": "Logs Settings",
    "name": "logsGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "type": "RADIO",
        "name": "logType",
        "radioItems": [
          {
            "value": "no",
            "displayValue": "Do not log"
          },
          {
            "value": "debug",
            "displayValue": "Log to console during debug and preview"
          },
          {
            "value": "always",
            "displayValue": "Always log to console"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "debug"
      }
    ]
  },
  {
    "displayName": "BigQuery Logs Settings",
    "name": "bigQueryLogsGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "type": "RADIO",
        "name": "bigQueryLogType",
        "radioItems": [
          {
            "value": "no",
            "displayValue": "Do not log to BigQuery"
          },
          {
            "value": "always",
            "displayValue": "Log to BigQuery"
          }
        ],
        "simpleValueType": true,
        "defaultValue": "no"
      },
      {
        "type": "GROUP",
        "name": "logsBigQueryConfigGroup",
        "groupStyle": "NO_ZIPPY",
        "subParams": [
          {
            "type": "TEXT",
            "name": "logBigQueryProjectId",
            "displayName": "BigQuery Project ID",
            "simpleValueType": true,
            "help": "Optional.  \u003cbr\u003e\u003cbr\u003e  If omitted, it will be retrieved from the environment variable \u003cI\u003eGOOGLE_CLOUD_PROJECT\u003c/i\u003e where the server container is running. If the server container is running on Google Cloud, \u003cI\u003eGOOGLE_CLOUD_PROJECT\u003c/i\u003e will already be set to the Google Cloud project\u0027s ID."
          },
          {
            "type": "TEXT",
            "name": "logBigQueryDatasetId",
            "displayName": "BigQuery Dataset ID",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          },
          {
            "type": "TEXT",
            "name": "logBigQueryTableId",
            "displayName": "BigQuery Table ID",
            "simpleValueType": true,
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ]
          }
        ],
        "enablingConditions": [
          {
            "paramName": "bigQueryLogType",
            "paramValue": "always",
            "type": "EQUALS"
          }
        ]
      }
    ]
  }
]


___SANDBOXED_JS_FOR_SERVER___

/// <reference path="./server-gtm-sandboxed-apis.d.ts" />

const BigQuery = require('BigQuery');
const encodeUriComponent = require('encodeUriComponent');
const getAllEventData = require('getAllEventData');
const getContainerVersion = require('getContainerVersion');
const getGoogleAuth = require('getGoogleAuth');
const getRequestHeader = require('getRequestHeader');
const getTimestampMillis = require('getTimestampMillis');
const getType = require('getType');
const JSON = require('JSON');
const logToConsole = require('logToConsole');
const makeInteger = require('makeInteger');
const makeNumber = require('makeNumber');
const makeString = require('makeString');
const Math = require('Math');
const Object = require('Object');
const sendHttpRequest = require('sendHttpRequest');
const sha256Sync = require('sha256Sync');

/*==============================================================================
==============================================================================*/

const traceId = getRequestHeader('trace-id');
const eventData = getAllEventData();
const useOptimisticScenario = isUIFieldTrue(data.useOptimisticScenario);

if (!isConsentGivenOrNotRequired(data, eventData)) {
  return data.gtmOnSuccess();
}

const url = eventData.page_location || getRequestHeader('referer');
if (url && url.lastIndexOf('https://gtm-msr.appspot.com/', 0) === 0) {
  return data.gtmOnSuccess();
}

const mappedData = getDataForConversionEventsUpload(data, eventData);
sendRequest(data, mappedData);

if (useOptimisticScenario) {
  return data.gtmOnSuccess();
}

/*==============================================================================
  Vendor related functions
==============================================================================*/

function addDestinationsData(data, mappedData) {
  const destinations = [];
  const accountsAndDestinationsFromUI =
    data.stapeAuthDestinationsList || data.ownAuthDestinationsList; // Mutually exclusive.

  accountsAndDestinationsFromUI.forEach((row) => {
    const productDestinationId = makeString(row.productDestinationId);
    const destination = {
      reference: productDestinationId,
      productDestinationId: productDestinationId,
      operatingAccount: {
        product: row.product,
        accountId: makeString(row.operatingAccountId)
      }
    };

    if (data.authFlow === 'stape' && row.linkedAccountId) {
      destination.linkedAccount = {
        product: row.product,
        accountId: makeString(row.linkedAccountId)
      };
    }

    if (data.authFlow === 'own' && row.loginAccountId) {
      destination.loginAccount = {
        product: row.product,
        accountId: makeString(row.loginAccountId)
      };
    }

    destinations.push(destination);
  });

  mappedData.destinations = destinations;

  return mappedData;
}

function addConsentData(data, mappedData) {
  const consent = {};
  const consentTypes = ['adUserData', 'adPersonalization'];

  consentTypes.forEach((consentType) => {
    if (!data[consentType]) return;
    consent[consentType] = data[consentType];
    mappedData.consent = consent;
  });

  return mappedData;
}

function getEmailAddressesFromEventData(eventData) {
  const eventDataUserData = eventData.user_data || {};

  let email =
    eventDataUserData.email ||
    eventDataUserData.email_address ||
    eventDataUserData.sha256_email ||
    eventDataUserData.sha256_email_address;

  const emailType = getType(email);

  if (emailType === 'string') email = [email];
  else if (emailType === 'array') email = email.length > 0 ? email : undefined;
  else if (emailType === 'object') {
    const emailsFromObject = Object.values(email);
    if (emailsFromObject.length) email = emailsFromObject;
  }

  return email;
}

function getPhoneNumbersFromEventData(eventData) {
  const eventDataUserData = eventData.user_data || {};

  let phone =
    eventDataUserData.phone ||
    eventDataUserData.phone_number ||
    eventDataUserData.sha256_phone_number;

  const phoneType = getType(phone);

  if (phoneType === 'string') phone = [phone];
  else if (phoneType === 'array') phone = phone.length > 0 ? phone : undefined;
  else if (phoneType === 'object') {
    const phonesFromObject = Object.values(phone);
    if (phonesFromObject.length) phone = phonesFromObject;
  }

  return phone;
}

function getAddressFromEventData(eventData) {
  const eventDataUserData = eventData.user_data || {};
  let eventDataUserDataAddress = {};
  const addressType = getType(eventDataUserData.address);
  if (addressType === 'object' || addressType === 'array') {
    eventDataUserDataAddress = eventDataUserData.address[0] || eventDataUserData.address;
  }

  const firstName =
    eventDataUserDataAddress.first_name || eventDataUserDataAddress.sha256_first_name;
  const lastName = eventDataUserDataAddress.last_name || eventDataUserDataAddress.sha256_last_name;
  const postalCode = eventDataUserDataAddress.postal_code;
  const regionCode = eventDataUserDataAddress.country;

  if (firstName && lastName && postalCode && regionCode) {
    return {
      givenName: makeString(firstName),
      familyName: makeString(lastName),
      postalCode: makeString(postalCode),
      regionCode: makeString(regionCode)
    };
  }
}

function addConversionInformation(data, eventData, conversionEvent) {
  const getValueFromItems = (eventData) => {
    if (getType(eventData.items) !== 'array' || eventData.items.length === 0) return;

    let valueFromItems = 0;
    eventData.items.forEach((i) => {
      if (!isValidValue(i.price)) return;
      const itemPrice = makeNumber(i.price);
      const itemQuantity = makeInteger(i.quantity);
      valueFromItems += itemQuantity ? itemQuantity * itemPrice : itemPrice;
    });

    return valueFromItems;
  };

  if (isUIFieldTrue(data.autoMapConversionInformation)) {
    if (eventData.transaction_id) {
      conversionEvent.transactionId = makeString(eventData.transaction_id);
    }

    if (eventData.currency) conversionEvent.currency = eventData.currency;

    const conversionValue = eventData.value || getValueFromItems(eventData);
    if (isValidValue(conversionValue)) conversionEvent.conversionValue = conversionValue;
  }

  if (data.transactionId) conversionEvent.transactionId = makeString(data.transactionId);

  if (data.eventTimestamp) {
    conversionEvent.eventTimestamp = getConversionDateTime(data.eventTimestamp);
  } else conversionEvent.eventTimestamp = getConversionDateTime();

  if (data.lastUpdatedTimestamp) {
    conversionEvent.lastUpdatedTimestamp = getConversionDateTime(data.lastUpdatedTimestamp);
  }

  if (data.currency) conversionEvent.currency = data.currency;

  if (isValidValue(data.conversionValue)) {
    conversionEvent.conversionValue = makeNumber(data.conversionValue);
  }

  if (data.eventSource) conversionEvent.eventSource = data.eventSource;

  return conversionEvent;
}

function addUserData(data, eventData, conversionEvent) {
  const itemizeUserIdentifier = (input) => {
    const type = getType(input);
    if (type === 'array') return input.filter((e) => e);
    if (type === 'string' || type === 'number') return [input];
    return [];
  };
  const userDataIDsLengthLimit = 10;

  let emailAddresses;
  let phoneNumbers;
  let address;

  if (isUIFieldTrue(data.autoMapUserData)) {
    emailAddresses = getEmailAddressesFromEventData(eventData);
    phoneNumbers = getPhoneNumbersFromEventData(eventData);
    address = getAddressFromEventData(eventData);
  }

  if (data.userDataEmailAddresses) emailAddresses = data.userDataEmailAddresses;
  if (data.userDataPhoneNumbers) phoneNumbers = data.userDataPhoneNumbers;
  if (data.addUserDataAddress) {
    const addressUIFields = [
      'userDataAddressGivenName',
      'userDataAddressFamilyName',
      'userDataAddressRegion',
      'userDataAddressPostalCode'
    ];
    const inputAllAddressFieldsAreValid = addressUIFields.every((p) => isValidValue(data[p]));

    if (inputAllAddressFieldsAreValid) {
      address = {
        givenName: makeString(data.userDataAddressGivenName),
        familyName: makeString(data.userDataAddressFamilyName),
        regionCode: makeString(data.userDataAddressRegion),
        postalCode: makeString(data.userDataAddressPostalCode)
      };
    }
  }

  if (emailAddresses || phoneNumbers || address) {
    const userIdentifiers = [];

    if (emailAddresses) {
      emailAddresses = itemizeUserIdentifier(emailAddresses);
      if (emailAddresses.length) {
        emailAddresses.forEach((email) => userIdentifiers.push({ emailAddress: email }));
      }
    }

    if (phoneNumbers) {
      phoneNumbers = itemizeUserIdentifier(phoneNumbers);
      if (phoneNumbers.length) {
        phoneNumbers.forEach((phone) => userIdentifiers.push({ phoneNumber: phone }));
      }
    }

    if (address) {
      userIdentifiers.push({
        address: address
      });
    }

    if (userIdentifiers.length > 0) {
      conversionEvent.userData = {
        userIdentifiers: userIdentifiers.slice(0, userDataIDsLengthLimit)
      };
    }
  }

  return conversionEvent;
}

function addAdIdentifiers(data, conversionEvent) {
  const adIdentifiers = {};

  if (data.adIdentifiersGclid) adIdentifiers.gclid = data.adIdentifiersGclid;
  if (data.adIdentifiersGbraid) adIdentifiers.gbraid = data.adIdentifiersGbraid;
  if (data.adIdentifiersWbraid) adIdentifiers.wbraid = data.adIdentifiersWbraid;

  if (data.adIdentifiersLandingPageDeviceInfoUserAgent) {
    adIdentifiers.landingPageDeviceInfo = adIdentifiers.landingPageDeviceInfo || {};
    adIdentifiers.landingPageDeviceInfo.userAgent =
      data.adIdentifiersLandingPageDeviceInfoUserAgent;
  }
  if (data.adIdentifiersLandingPageDeviceInfoIpAddress) {
    adIdentifiers.landingPageDeviceInfo = adIdentifiers.landingPageDeviceInfo || {};
    adIdentifiers.landingPageDeviceInfo.ipAddress =
      data.adIdentifiersLandingPageDeviceInfoIpAddress;
  }

  if (data.adIdentifiersSessionAttributes) {
    adIdentifiers.sessionAttributes = data.adIdentifiersSessionAttributes;
  }

  if (hasProps(adIdentifiers)) conversionEvent.adIdentifiers = adIdentifiers;

  return conversionEvent;
}

function addEventDeviceInformation(data, eventData, conversionEvent) {
  const eventDeviceInfo = {};

  if (isUIFieldTrue(data.autoMapEventDeviceInfo)) {
    if (eventData.user_agent) eventDeviceInfo.userAgent = eventData.user_agent;
    if (eventData.ip_override) eventDeviceInfo.ipAddress = eventData.ip_override;
  }

  if (data.eventDeviceInfoUserAgent) eventDeviceInfo.userAgent = data.eventDeviceInfoUserAgent;
  if (data.eventDeviceInfoIpAddress) eventDeviceInfo.ipAddress = data.eventDeviceInfoIpAddress;

  if (hasProps(eventDeviceInfo)) conversionEvent.eventDeviceInfo = eventDeviceInfo;

  return conversionEvent;
}

function addUserProperties(data, conversionEvent) {
  const userProperties = {};

  if (data.userPropertiesCustomerType) {
    userProperties.customerType = data.userPropertiesCustomerType;
  }

  if (data.userPropertiesCustomerValueBucket) {
    userProperties.customerValueBucket = data.userPropertiesCustomerValueBucket;
  }

  if (hasProps(userProperties)) {
    conversionEvent.userProperties = userProperties;
  }

  return conversionEvent;
}

function addCartData(data, eventData, conversionEvent) {
  const cartData = {};

  if (isUIFieldTrue(data.autoMapCartData)) {
    if (getType(eventData.items) === 'array' && eventData.items.length > 0) {
      const itemIdKey = data.itemIdKey ? data.itemIdKey : 'item_id';
      cartData.items = eventData.items.map((i) => {
        const item = {};
        if (i[itemIdKey]) item.merchantProductId = makeString(i[itemIdKey]);
        if (i.quantity) item.quantity = makeString(i.quantity);
        if (isValidValue(i.price)) item.unitPrice = makeNumber(i.price);
        return item;
      });
    }
  }

  if (data.cartDataMerchantId) cartData.merchantId = makeString(data.cartDataMerchantId);

  if (data.cartDataMerchantFeedLabel) {
    cartData.merchantFeedLabel = makeString(data.cartDataMerchantFeedLabel);
  }

  if (data.cartDataMerchantFeedLanguageCode) {
    cartData.merchantFeedLanguageCode = makeString(data.cartDataMerchantFeedLanguageCode);
  }

  if (isValidValue(data.cartDataTransactionDiscount)) {
    cartData.transactionDiscount = makeNumber(data.cartDataTransactionDiscount);
  }

  if (getType(data.cartDataItems) === 'array' && data.cartDataItems.length > 0) {
    cartData.items = data.cartDataItems.map((i) => {
      const item = {};
      if (i.merchantProductId) item.merchantProductId = makeString(i.merchantProductId);
      if (i.quantity) item.quantity = makeString(i.quantity);
      if (i.unitPrice) item.unitPrice = makeNumber(i.unitPrice);
      return item;
    });
  }

  if (hasProps(cartData)) conversionEvent.cartData = cartData;

  return conversionEvent;
}

function addCustomVariables(data, conversionEvent) {
  const customVariables = [];

  if (data.customVariablesList) {
    data.customVariablesList.forEach((d) => {
      if (!isValidValue(d.value)) return;

      const customVariable = { variable: makeString(d.name), value: makeString(d.value) };

      if (d.destinationReferences) {
        const destinationReferences = (
          getType(d.destinationReferences) === 'array'
            ? d.destinationReferences
            : [d.destinationReferences]
        )
          .filter((dr) => isValidValue(dr))
          .map((dr) => makeString(dr));

        if (destinationReferences.length) {
          customVariable.destinationReferences = destinationReferences;
        }
      }

      customVariables.push(customVariable);
    });

    if (customVariables.length > 0) conversionEvent.customVariables = customVariables;
  }

  return conversionEvent;
}

function addExperimentalFields(data, conversionEvent) {
  const experimentalFields = [];

  if (data.experimentalFieldsList) {
    data.experimentalFieldsList.forEach((d) => {
      if (!isValidValue(d.value)) return;

      experimentalFields.push({ field: d.name, value: makeString(d.value) });
    });

    if (experimentalFields.length > 0) conversionEvent.experimentalFields = experimentalFields;
  }

  return conversionEvent;
}

function addConversionEventsData(data, eventData, mappedData) {
  if (data.conversionEventMode === 'single') {
    const conversionEvent = {};

    addConversionInformation(data, eventData, conversionEvent);
    addUserData(data, eventData, conversionEvent);
    addAdIdentifiers(data, conversionEvent);
    addEventDeviceInformation(data, eventData, conversionEvent);
    addUserProperties(data, conversionEvent);
    addCartData(data, eventData, conversionEvent);
    addCustomVariables(data, conversionEvent);
    addExperimentalFields(data, conversionEvent);

    mappedData.events = [conversionEvent];
  } else if (
    data.conversionEventMode === 'multiple' &&
    getType(data.conversionEvents) === 'array'
  ) {
    mappedData.events = data.conversionEvents;
  }

  return mappedData;
}

function addEncodingData(data, mappedData) {
  // Avoids overwriting the encoding information if the tag auto-hashed (HEX output) User Data.
  const encoding = mappedData.encoding || data.userDataEncoding;
  if (encoding) mappedData.encoding = encoding;

  return mappedData;
}

function addEncryptionData(data, mappedData) {
  const encryptionInfo = {
    gcpWrappedKeyInfo: {
      keyType: data.gcpWrappedKeyType,
      wipProvider: data.gcpWrappedKeyWipProvider,
      kekUri: data.gcpWrappedKeyKekUri,
      encryptedDek: data.gcpWrappedKeyEncryptedDek
    }
  };

  mappedData.encryptionInfo = encryptionInfo;

  return mappedData;
}

function normalizeEmailAddress(email) {
  if (!email) return email;

  const emailParts = email.split('@');
  if (emailParts[1] === 'gmail.com' || emailParts[1] === 'googlemail.com') {
    return emailParts[0].split('.').join('') + '@' + emailParts[1];
  }
  return emailParts.join('@');
}

function normalizePhoneNumber(phoneNumber) {
  if (!phoneNumber) return phoneNumber;

  phoneNumber = phoneNumber
    .split(' ')
    .join('')
    .split('-')
    .join('')
    .split('(')
    .join('')
    .split(')')
    .join('');
  if (phoneNumber[0] !== '+') phoneNumber = '+' + phoneNumber;
  return phoneNumber;
}

function hashDataIfNeeded(mappedData) {
  const conversionEvents = mappedData.events;

  if (getType(conversionEvents) !== 'array') return;

  conversionEvents.forEach((conversionEvent) => {
    if (
      getType(conversionEvent) !== 'object' ||
      getType(conversionEvent.userData) !== 'object' ||
      getType(conversionEvent.userData.userIdentifiers) !== 'array'
    ) {
      return;
    }

    conversionEvent.userData.userIdentifiers.forEach((userIdentifier) => {
      const key = Object.keys(userIdentifier)[0];

      if (key === 'emailAddress' || key === 'phoneNumber') {
        let value = userIdentifier[key];

        if (isSHA256HexHashed(value)) {
          mappedData.encoding = 'HEX';
          return;
        } else if (isSHA256Base64Hashed(value)) {
          mappedData.encoding = 'BASE64';
          return;
        }

        if (key === 'phoneNumber') value = normalizePhoneNumber(value);
        else if (key === 'emailAddress') value = normalizeEmailAddress(value);

        userIdentifier[key] = hashData(value);
        mappedData.encoding = 'HEX';
      } else if (key === 'address') {
        const addressKeysToHash = ['givenName', 'familyName'];

        addressKeysToHash.forEach((nameKey) => {
          const value = userIdentifier.address[nameKey];
          if (!value) return;

          if (isSHA256HexHashed(value)) {
            mappedData.encoding = 'HEX';
            return;
          } else if (isSHA256Base64Hashed(value)) {
            mappedData.encoding = 'BASE64';
            return;
          }

          userIdentifier.address[nameKey] = hashData(value);
          mappedData.encoding = 'HEX';
        });
      }
    });
  });

  return mappedData;
}

function generateRequestUrl(data) {
  if (data.authFlow === 'own') {
    const apiVersion = '1';
    return 'https://datamanager.googleapis.com/v' + apiVersion + '/events:ingest';
  }

  const containerIdentifier = getRequestHeader('x-gtm-identifier');
  const defaultDomain = getRequestHeader('x-gtm-default-domain');
  const containerApiKey = getRequestHeader('x-gtm-api-key');
  return (
    'https://' +
    enc(containerIdentifier) +
    '.' +
    enc(defaultDomain) +
    '/stape-api/' +
    enc(containerApiKey) +
    '/v2/data-manager/events/ingest'
  );
}

function generateRequestOptions(data) {
  const options = {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    }
  };

  if (data.authFlow === 'own') {
    const auth = getGoogleAuth({
      scopes: ['https://www.googleapis.com/auth/datamanager']
    });
    options.authorization = auth;
    if (data.xGoogUserProject) options.headers['x-goog-user-project'] = data.xGoogUserProject;
  }

  return options;
}

function getDataForConversionEventsUpload(data, eventData) {
  const mappedData = {
    validateOnly: isUIFieldTrue(data.validateOnly)
  };

  addDestinationsData(data, mappedData);
  addConsentData(data, mappedData);
  addConversionEventsData(data, eventData, mappedData);
  hashDataIfNeeded(mappedData); // This should come before addEncodingData().
  addEncodingData(data, mappedData);
  if (isUIFieldTrue(data.enableUserDataEncryption)) {
    addEncryptionData(data, mappedData);
  }

  return mappedData;
}

function sendRequest(data, mappedData) {
  const requestUrl = generateRequestUrl(data);
  const requestOptions = generateRequestOptions(data);
  const requestBody = mappedData;

  log({
    Name: 'GoogleConversionEvent',
    Type: 'Request',
    TraceId: traceId,
    EventName: 'ConversionEvent',
    RequestMethod: 'POST',
    RequestUrl: requestUrl,
    RequestBody: requestBody
  });

  return sendHttpRequest(requestUrl, requestOptions, JSON.stringify(requestBody))
    .then((result) => {
      // .then has to be used when the Authorization header is in use
      log({
        Name: 'GoogleConversionEvent',
        Type: 'Response',
        TraceId: traceId,
        EventName: 'ConversionEvent',
        ResponseStatusCode: result.statusCode,
        ResponseHeaders: result.headers,
        ResponseBody: result.body
      });

      if (!useOptimisticScenario) {
        if (result.statusCode >= 200 && result.statusCode < 400) {
          data.gtmOnSuccess();
        } else {
          data.gtmOnFailure();
        }
      }
    })
    .catch((result) => {
      log({
        Name: 'GoogleConversionEvent',
        Type: 'Message',
        TraceId: traceId,
        EventName: 'ConversionEvent',
        Message: 'Request failed or timed out.',
        Reason: JSON.stringify(result)
      });

      if (!useOptimisticScenario) data.gtmOnFailure();
    });
}

/*==============================================================================
  Helpers
==============================================================================*/

function enc(data) {
  return encodeUriComponent(makeString(data || ''));
}

function hasProps(obj) {
  return Object.keys(obj).length > 0;
}

function isSHA256Base64Hashed(value) {
  if (!value) return false;
  const valueStr = makeString(value);
  const base64Regex = '^[A-Za-z0-9+/]{43}=?$';
  return valueStr.match(base64Regex) !== null;
}

function isSHA256HexHashed(value) {
  if (!value) return false;
  const valueStr = makeString(value);
  const hexRegex = '^[A-Fa-f0-9]{64}$';
  return valueStr.match(hexRegex) !== null;
}

function hashData(value) {
  if (!value) return value;

  const type = getType(value);

  if (value === 'undefined' || value === 'null') return undefined;

  if (type === 'array') {
    return value.map((val) => hashData(val));
  }

  if (type === 'object') {
    return Object.keys(value).reduce((acc, val) => {
      acc[val] = hashData(value[val]);
      return acc;
    }, {});
  }

  if (isSHA256HexHashed(value) || isSHA256Base64Hashed(value)) return value;

  return sha256Sync(makeString(value).trim().toLowerCase(), {
    outputEncoding: 'hex'
  });
}

function getConversionDateTime(timestamp) {
  if (!timestamp) return convertTimestampToRFC(getTimestampMillis());

  let timestampInt = makeInteger(timestamp);
  if (timestampInt && getType(timestampInt) === 'number') {
    const timestampString = makeString(timestamp);
    // This will be false only in 2286, when timestamps in seconds starts to have 11 digits.
    timestampInt = timestampString.length === 10 ? timestamp * 1000 : timestamp;
    return convertTimestampToRFC(timestampInt);
  }

  return timestamp;
}

function convertTimestampToRFC(timestamp) {
  const secToMs = function (s) {
    return s * 1000;
  };
  const minToMs = function (m) {
    return m * secToMs(60);
  };
  const hoursToMs = function (h) {
    return h * minToMs(60);
  };
  const daysToMs = function (d) {
    return d * hoursToMs(24);
  };
  const format = function (value) {
    return value >= 10 ? value.toString() : '0' + value;
  };
  const fourYearsInMs = daysToMs(365 * 4 + 1);
  let year = 1970 + Math.floor(timestamp / fourYearsInMs) * 4;
  timestamp = timestamp % fourYearsInMs;

  while (true) {
    const isLeapYear = !(year % 4);
    const nextTimestamp = timestamp - daysToMs(isLeapYear ? 366 : 365);
    if (nextTimestamp < 0) {
      break;
    }
    timestamp = nextTimestamp;
    year = year + 1;
  }

  const daysByMonth =
    year % 4 === 0
      ? [31, 29, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31]
      : [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

  let month = 0;
  for (let i = 0; i < daysByMonth.length; i++) {
    const msInThisMonth = daysToMs(daysByMonth[i]);
    if (timestamp > msInThisMonth) {
      timestamp = timestamp - msInThisMonth;
    } else {
      month = i + 1;
      break;
    }
  }
  const date = Math.ceil(timestamp / daysToMs(1));
  timestamp = timestamp - daysToMs(date - 1);
  const hours = Math.floor(timestamp / hoursToMs(1));
  timestamp = timestamp - hoursToMs(hours);
  const minutes = Math.floor(timestamp / minToMs(1));
  timestamp = timestamp - minToMs(minutes);
  const sec = Math.floor(timestamp / secToMs(1));

  return (
    year +
    '-' +
    format(month) +
    '-' +
    format(date) +
    'T' +
    format(hours) +
    ':' +
    format(minutes) +
    ':' +
    format(sec) +
    '+00:00'
  );
}

function isValidValue(value) {
  const valueType = getType(value);
  return valueType !== 'null' && valueType !== 'undefined' && value !== '';
}

function isUIFieldTrue(field) {
  return [true, 'true'].indexOf(field) !== -1;
}

function isConsentGivenOrNotRequired(data, eventData) {
  if (data.adStorageConsent !== 'required') return true;
  if (eventData.consent_state) return !!eventData.consent_state.ad_storage;
  const xGaGcs = eventData['x-ga-gcs'] || ''; // x-ga-gcs is a string like "G110"
  return xGaGcs[2] === '1';
}

function log(rawDataToLog) {
  const logDestinationsHandlers = {};
  if (determinateIsLoggingEnabled()) logDestinationsHandlers.console = logConsole;
  if (determinateIsLoggingEnabledForBigQuery()) logDestinationsHandlers.bigQuery = logToBigQuery;

  const keyMappings = {
    // No transformation for Console is needed.
    bigQuery: {
      Name: 'tag_name',
      Type: 'type',
      TraceId: 'trace_id',
      EventName: 'event_name',
      RequestMethod: 'request_method',
      RequestUrl: 'request_url',
      RequestBody: 'request_body',
      ResponseStatusCode: 'response_status_code',
      ResponseHeaders: 'response_headers',
      ResponseBody: 'response_body'
    }
  };

  for (const logDestination in logDestinationsHandlers) {
    const handler = logDestinationsHandlers[logDestination];
    if (!handler) continue;

    const mapping = keyMappings[logDestination];
    const dataToLog = mapping ? {} : rawDataToLog;

    if (mapping) {
      for (const key in rawDataToLog) {
        const mappedKey = mapping[key] || key;
        dataToLog[mappedKey] = rawDataToLog[key];
      }
    }

    handler(dataToLog);
  }
}

function logConsole(dataToLog) {
  logToConsole(JSON.stringify(dataToLog));
}

function logToBigQuery(dataToLog) {
  const connectionInfo = {
    projectId: data.logBigQueryProjectId,
    datasetId: data.logBigQueryDatasetId,
    tableId: data.logBigQueryTableId
  };

  dataToLog.timestamp = getTimestampMillis();

  ['request_body', 'response_headers', 'response_body'].forEach((p) => {
    dataToLog[p] = JSON.stringify(dataToLog[p]);
  });

  BigQuery.insert(connectionInfo, [dataToLog], { ignoreUnknownValues: true });
}

function determinateIsLoggingEnabled() {
  const containerVersion = getContainerVersion();
  const isDebug = !!(
    containerVersion &&
    (containerVersion.debugMode || containerVersion.previewMode)
  );

  if (!data.logType) {
    return isDebug;
  }

  if (data.logType === 'no') {
    return false;
  }

  if (data.logType === 'debug') {
    return isDebug;
  }

  return data.logType === 'always';
}

function determinateIsLoggingEnabledForBigQuery() {
  if (data.bigQueryLogType === 'no') return false;
  return data.bigQueryLogType === 'always';
}


___SERVER_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "read_request",
        "versionId": "1"
      },
      "param": [
        {
          "key": "headerWhitelist",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "trace-id"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "referer"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "x-gtm-identifier"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "x-gtm-default-domain"
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "headerName"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "x-gtm-api-key"
                  }
                ]
              }
            ]
          }
        },
        {
          "key": "headersAllowed",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "requestAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "headerAccess",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "queryParameterAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_container_data",
        "versionId": "1"
      },
      "param": []
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_event_data",
        "versionId": "1"
      },
      "param": [
        {
          "key": "eventDataAccess",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "send_http",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedUrls",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://datamanager.googleapis.com/*"
              },
              {
                "type": 1,
                "string": "https://*.stape.io/*"
              },
              {
                "type": 1,
                "string": "https://*.stape.net/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_bigquery",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedTables",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "projectId"
                  },
                  {
                    "type": 1,
                    "string": "datasetId"
                  },
                  {
                    "type": 1,
                    "string": "tableId"
                  },
                  {
                    "type": 1,
                    "string": "operation"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "*"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "use_google_credentials",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedScopes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://www.googleapis.com/auth/datamanager"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: '[Stape Connection] Request URL is successfully built and sent'
  code: |-
    setAllMockDataByAuthMethod('stape');

    mock('sendHttpRequest', (requestUrl, requestOptions, requestBody) => {
      assertThat(requestUrl).isEqualTo('https://expectedXGtmIdentifier.expectedXGtmDefaultDomain/stape-api/expectedXGtmApiKey/v2/data-manager/events/ingest');
      return Promise.create((resolve, reject) => {
        resolve({ statusCode: 200 });
      });
    });

    runCode(mockData);

    callLater(() => {
      assertApi('gtmOnSuccess').wasCalled();
      assertApi('gtmOnFailure').wasNotCalled();
    });
- name: '[Own Connection] Request URL is successfully built and sent'
  code: |-
    setAllMockDataByAuthMethod('own');

    mock('sendHttpRequest', (requestUrl, requestOptions, requestBody) => {
      assertThat(requestUrl).isEqualTo('https://datamanager.googleapis.com/v1/events:ingest');
      return Promise.create((resolve, reject) => {
        resolve({ statusCode: 200 });
      });
    });

    runCode(mockData);

    callLater(() => {
      assertApi('gtmOnSuccess').wasCalled();
      assertApi('gtmOnFailure').wasNotCalled();
    });
- name: '[Stape Connection] Request Options are successfully built and sent'
  code: "setAllMockDataByAuthMethod('stape');\n\nmock('sendHttpRequest', (requestUrl,\
    \ requestOptions, requestBody) => {\n  assertThat(requestOptions).isEqualTo({\n\
    \    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json'\n\
    \    }\n  });\n\n  return Promise.create((resolve, reject) => {\n    resolve({\
    \ statusCode: 200 });\n  });  \n});\n\nrunCode(mockData);\n\ncallLater(() => {\n\
    \  assertApi('gtmOnSuccess').wasCalled();\n  assertApi('gtmOnFailure').wasNotCalled();\n\
    });"
- name: '[Own Connection] Request Options are successfully built and sent'
  code: "setAllMockDataByAuthMethod('own');\n\nmock('sendHttpRequest', (requestUrl,\
    \ requestOptions, requestBody) => {\n  assertThat(requestOptions).isEqualTo({\n\
    \    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json'\n\
    \    },\n    authorization: 'googleAuthToken'\n  });\n\n  return Promise.create((resolve,\
    \ reject) => {\n    resolve({ statusCode: 200 });\n  });  \n});\n\nrunCode(mockData);\n\
    \ncallLater(() => {\n  assertApi('getGoogleAuth').wasCalledWith({\n    scopes:\
    \ ['https://www.googleapis.com/auth/datamanager']\n  });\n  assertApi('gtmOnSuccess').wasCalled();\n\
    \  assertApi('gtmOnFailure').wasNotCalled();\n});"
- name: '[Single Event] [Data from auto-mapping] Request is successfully built and
    sent'
  code: "setGetAllEventData();\n\nsetAllMockDataByAuthMethod('stape', {\n  conversionEventMode:\
    \ 'single',\n  autoMapConversionInformation: true,\n  autoMapUserData: true,\n\
    \  autoMapEventDeviceInfo: true,\n  autoMapCartData: true\n});\n\n[\n  'transactionId',\n\
    \  'currency',\n  'conversionValue',\n  'userDataEmailAddresses',\n  'userDataPhoneNumbers',\n\
    \  'addressGivenName',\n  'addressFamilyName',\n  'addressRegion',\n  'addressPostalCode',\n\
    \  'eventDeviceInfoUserAgent',\n  'eventDeviceInfoIpAddress',\n  'cartDataItems'\n\
    ].forEach((key) => Object.delete(mockData, key));\n\nmock('sendHttpRequest', (requestUrl,\
    \ requestOptions, requestBody) => {\n  const parsedRequestBody = JSON.parse(requestBody);\n\
    \  assertThat(parsedRequestBody).isEqualTo({\n    validateOnly: false,\n    destinations:\
    \ [\n      {\n        reference: 'productDestinationId',\n        productDestinationId:\
    \ 'productDestinationId',\n        operatingAccount: {\n          product: 'GOOGLE_ADS',\n\
    \          accountId: 'operatingAccountId'\n        },\n        linkedAccount:\
    \ { product: 'GOOGLE_ADS', accountId: 'linkedAccountId' }\n      },\n      {\n\
    \        reference: 'productDestinationId1',\n        productDestinationId: 'productDestinationId1',\n\
    \        operatingAccount: {\n          product: 'GOOGLE_ADS',\n          accountId:\
    \ 'operatingAccountId1'\n        },\n        linkedAccount: { product: 'GOOGLE_ADS',\
    \ accountId: 'linkedAccountId1' }\n      }\n    ],\n    consent: {\n      adUserData:\
    \ 'CONSENT_GRANTED',\n      adPersonalization: 'CONSENT_DENIED'\n    },\n    events:\
    \ [\n      {\n        transactionId: 'transaction_id',\n        currency: 'BRL',\n\
    \        conversionValue: 123.45,\n        eventTimestamp: '2014-10-02T15:01:23Z',\n\
    \        lastUpdatedTimestamp: '2014-10-02T15:01:23Z',\n        eventSource: 'WEB',\n\
    \        userData: {\n          userIdentifiers: [\n            {\n          \
    \    emailAddress:\n                'ddffdce54594d729a13068951750239a1943c295a5f89349b5cf69744d4a1ba2'\n\
    \            },\n            {\n              emailAddress:\n                'afea90f78a2e604dc6cc5d7826ffdd2bfbab612a0c1222acf8df173319b7e809'\n\
    \            },\n            {\n              phoneNumber:\n                'c698c0b85d32cbcf5033ada58f34de87d4f7415efaf5a8d1c1e9e63393dcc85e'\n\
    \            },\n            {\n              address: {\n                givenName:\n\
    \                  '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \                familyName:\n                  '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \                regionCode: 'US',\n                postalCode: '10001'\n    \
    \          }\n            }\n          ]\n        },\n        adIdentifiers: {\n\
    \          gclid: 'gclid',\n          gbraid: 'gbraid',\n          wbraid: 'wbraid',\n\
    \          landingPageDeviceInfo: {\n            userAgent: 'Landing Page User\
    \ Agent',\n            ipAddress: '1.1.1.1'\n          },\n          sessionAttributes:\
    \ 'Session Attributes'\n        },\n        eventDeviceInfo: { userAgent: 'user_agent',\
    \ ipAddress: 'ip_override' },\n        userProperties: { customerType: 'NEW',\
    \ customerValueBucket: 'LOW' },\n        cartData: {\n          items: [\n   \
    \         { merchantProductId: 'SKU_12345', quantity: '3', unitPrice: 10.01 },\n\
    \            { merchantProductId: 'SKU_12346', quantity: '2', unitPrice: 21.01\
    \ }\n          ],\n          merchantId: 'Merchant Center ID',\n          merchantFeedLabel:\
    \ 'Merchant Center Feed Label',\n          merchantFeedLanguageCode: 'Merchant\
    \ Center Feed Language Code',\n          transactionDiscount: 123\n        },\n\
    \        customVariables: [\n          {\n            variable: 'TEST1',\n   \
    \         value: 'ABC',\n            destinationReferences: ['REFERENCE']\n  \
    \        },\n          { variable: 'TEST2', value: 'AAAAAAAA' },\n          {\n\
    \            variable: 'TEST3',\n            value: '123ABC',\n            destinationReferences:\
    \ ['REFERENCE', 'REFERENCE2']\n          }\n        ],\n        experimentalFields:\
    \ [{ field: 'ABC', value: 'FOOBAR' }]\n      }\n    ],\n    encoding: 'HEX',\n\
    \    encryptionInfo: {\n      gcpWrappedKeyInfo: {\n        keyType: 'XCHACHA20_POLY1305',\n\
    \        wipProvider: '123',\n        kekUri: '123',\n        encryptedDek: '123'\n\
    \      }\n    }\n  });\n\n  return Promise.create((resolve, reject) => {\n   \
    \ resolve({ statusCode: 200 });\n  });  \n});\n\nrunCode(mockData);\n\ncallLater(()\
    \ => {\n  assertApi('gtmOnSuccess').wasCalled();\n  assertApi('gtmOnFailure').wasNotCalled();\n\
    });"
- name: '[Single Event] [Data from UI fields] Request is successfully built and sent'
  code: "setAllMockDataByAuthMethod('stape', {\n  conversionEventMode: 'single'\n\
    });\n\nmock('sendHttpRequest', (requestUrl, requestOptions, requestBody) => {\n\
    \  const parsedRequestBody = JSON.parse(requestBody);\n    assertThat(parsedRequestBody).isEqualTo({\n\
    \    validateOnly: false,\n    destinations: [\n      {\n        reference: 'productDestinationId',\n\
    \        productDestinationId: 'productDestinationId',\n        operatingAccount:\
    \ {\n          product: 'GOOGLE_ADS',\n          accountId: 'operatingAccountId'\n\
    \        },\n        linkedAccount: { product: 'GOOGLE_ADS', accountId: 'linkedAccountId'\
    \ }\n      },\n      {\n        reference: 'productDestinationId1',\n        productDestinationId:\
    \ 'productDestinationId1',\n        operatingAccount: {\n          product: 'GOOGLE_ADS',\n\
    \          accountId: 'operatingAccountId1'\n        },\n        linkedAccount:\
    \ { product: 'GOOGLE_ADS', accountId: 'linkedAccountId1' }\n      }\n    ],\n\
    \    consent: {\n      adUserData: 'CONSENT_GRANTED',\n      adPersonalization:\
    \ 'CONSENT_DENIED'\n    },\n    events: [\n      {\n        transactionId: 'Transaction\
    \ ID',\n        eventTimestamp: '2014-10-02T15:01:23Z',\n        lastUpdatedTimestamp:\
    \ '2014-10-02T15:01:23Z',\n        currency: 'BRL',\n        conversionValue:\
    \ 123.45,\n        eventSource: 'WEB',\n        userData: {\n          userIdentifiers:\
    \ [\n            {\n              emailAddress:\n                '74790a65960d58724ba244c376e2bb6cbdd39f6c67d122760b319d51d11813a9'\n\
    \            },\n            {\n              phoneNumber:\n                '92effd108fc091e55b0239ffc94d867e649d45c28c3de6918ec1edcb0723602c'\n\
    \            },\n            {\n              address: {\n                givenName:\n\
    \                  '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \                familyName:\n                  '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \                regionCode: 'US',\n                postalCode: '10001'\n    \
    \          }\n            }\n          ]\n        },\n        adIdentifiers: {\n\
    \          gclid: 'gclid',\n          gbraid: 'gbraid',\n          wbraid: 'wbraid',\n\
    \          landingPageDeviceInfo: {\n            userAgent: 'Landing Page User\
    \ Agent',\n            ipAddress: '1.1.1.1'\n          },\n          sessionAttributes:\
    \ 'Session Attributes'\n        },\n        eventDeviceInfo: { userAgent: 'User\
    \ Agent', ipAddress: '1.1.1.1' },\n        userProperties: { customerType: 'NEW',\
    \ customerValueBucket: 'LOW' },\n        cartData: {\n          merchantId: 'Merchant\
    \ Center ID',\n          merchantFeedLabel: 'Merchant Center Feed Label',\n  \
    \        merchantFeedLanguageCode: 'Merchant Center Feed Language Code',\n   \
    \       transactionDiscount: 123,\n          items: [\n            {\n       \
    \       merchantProductId: 'Merchant Product ID 1',\n              quantity: '1',\n\
    \              unitPrice: 123\n            },\n            {\n              merchantProductId:\
    \ 'Merchant Product ID 2',\n              quantity: '2',\n              unitPrice:\
    \ 111\n            }\n          ]\n        },\n        customVariables: [\n  \
    \        {\n            variable: 'TEST1',\n            value: 'ABC',\n      \
    \      destinationReferences: ['REFERENCE']\n          },\n          { variable:\
    \ 'TEST2', value: 'AAAAAAAA' },\n          {\n            variable: 'TEST3',\n\
    \            value: '123ABC',\n            destinationReferences: ['REFERENCE',\
    \ 'REFERENCE2']\n          }\n        ],\n        experimentalFields: [{ field:\
    \ 'ABC', value: 'FOOBAR' }]\n      }\n    ],\n    encoding: 'HEX',\n    encryptionInfo:\
    \ {\n      gcpWrappedKeyInfo: {\n        keyType: 'XCHACHA20_POLY1305',\n    \
    \    wipProvider: '123',\n        kekUri: '123',\n        encryptedDek: '123'\n\
    \      }\n    }\n  });\n\n  return Promise.create((resolve, reject) => {\n   \
    \ resolve({ statusCode: 200 });\n  });  \n});\n\nrunCode(mockData);\n\ncallLater(()\
    \ => {\n  assertApi('gtmOnSuccess').wasCalled();\n  assertApi('gtmOnFailure').wasNotCalled();\n\
    });"
- name: '[Multiple Events] [Data from UI fields] Request is successfully built and
    sent'
  code: "setAllMockDataByAuthMethod('stape', {\n  conversionEventMode: 'multiple',\n\
    \  conversionEvents: [\n    {\n      destionationReference: 'productDestinationId1',\n\
    \      transactionId: 'Transaction ID 1',\n      eventTimestamp: '2014-10-02T15:01:23Z',\n\
    \      lastUpdatedTimestamp: '2014-10-02T15:01:23Z',\n      currency: 'BRL',\n\
    \      conversionValue: 123.45,\n      eventSource: 'WEB',\n      userData: {\n\
    \        userIdentifiers: [\n          {\n            emailAddress:\n        \
    \      'test1@example.net'\n          },\n          {\n            phoneNumber:\n\
    \              '+55199999999'\n          },\n          {\n            address:\
    \ {\n              givenName:\n                '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \              familyName:\n                '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \              regionCode: 'US',\n              postalCode: '10001'\n        \
    \    }\n          }\n        ]\n      },\n      adIdentifiers: {\n        gclid:\
    \ 'gclid',\n        gbraid: 'gbraid',\n        wbraid: 'wbraid',\n        landingPageDeviceInfo:\
    \ {\n          userAgent: 'Landing Page User Agent',\n          ipAddress: '1.1.1.1'\n\
    \        },\n        sessionAttributes: 'Session Attributes'\n      },\n     \
    \ eventDeviceInfo: { userAgent: 'User Agent', ipAddress: '1.1.1.1' },\n      userProperties:\
    \ { customerType: 'NEW', customerValueBucket: 'LOW' },\n      cartData: {\n  \
    \      merchantId: 'Merchant Center ID',\n        merchantFeedLabel: 'Merchant\
    \ Center Feed Label',\n        merchantFeedLanguageCode: 'Merchant Center Feed\
    \ Language Code',\n        transactionDiscount: 123,\n        items: [\n     \
    \     {\n            merchantProductId: 'Merchant Product ID 1',\n           \
    \ quantity: '1',\n            unitPrice: 123\n          },\n          {\n    \
    \        merchantProductId: 'Merchant Product ID 2',\n            quantity: '2',\n\
    \            unitPrice: 111\n          }\n        ]\n      },\n      customVariables:\
    \ [\n        {\n          variable: 'TEST1',\n          value: 'ABC',\n      \
    \    destinationReferences: ['REFERENCE']\n        },\n        { variable: 'TEST2',\
    \ value: 'AAAAAAAA' },\n        {\n          variable: 'TEST3',\n          value:\
    \ '123ABC',\n          destinationReferences: ['REFERENCE', 'REFERENCE2']\n  \
    \      }\n      ],\n      experimentalFields: [{ field: 'ABC', value: 'FOOBAR'\
    \ }]\n    },\n    {\n\n      transactionId: 'Transaction ID 2',\n      eventTimestamp:\
    \ '2014-10-02T15:01:23Z',\n      lastUpdatedTimestamp: '2014-10-02T15:01:23Z',\n\
    \      currency: 'BRL',\n      conversionValue: 1,\n      eventSource: 'WEB',\n\
    \      userData: {\n        userIdentifiers: [\n          {\n            emailAddress:\n\
    \              '74790a65960d58724ba244c376e2bb6cbdd39f6c67d122760b319d51d11813a9'\n\
    \          },\n          {\n            phoneNumber:\n              '92effd108fc091e55b0239ffc94d867e649d45c28c3de6918ec1edcb0723602c'\n\
    \          },\n          {\n            address: {\n              givenName:\n\
    \                'test',\n              familyName:\n                'test',\n\
    \              regionCode: 'US',\n              postalCode: '10001'\n        \
    \    }\n          }\n        ]\n      },\n      adIdentifiers: {\n        gclid:\
    \ 'gclid',\n        gbraid: 'gbraid',\n        wbraid: 'wbraid',\n        landingPageDeviceInfo:\
    \ {\n          userAgent: 'Landing Page User Agent',\n          ipAddress: '1.1.1.1'\n\
    \        },\n        sessionAttributes: 'Session Attributes'\n      },\n     \
    \ eventDeviceInfo: { userAgent: 'User Agent', ipAddress: '1.1.1.1' },\n      userProperties:\
    \ { customerType: 'NEW', customerValueBucket: 'LOW' },\n      cartData: {\n  \
    \      merchantId: 'Merchant Center ID',\n        merchantFeedLabel: 'Merchant\
    \ Center Feed Label',\n        merchantFeedLanguageCode: 'Merchant Center Feed\
    \ Language Code',\n        transactionDiscount: 123,\n        items: [\n     \
    \     {\n            merchantProductId: 'Merchant Product ID 1',\n           \
    \ quantity: '1',\n            unitPrice: 123\n          },\n          {\n    \
    \        merchantProductId: 'Merchant Product ID 2',\n            quantity: '2',\n\
    \            unitPrice: 111\n          }\n        ]\n      },\n      customVariables:\
    \ [\n        {\n          variable: 'TEST1',\n          value: 'ABC',\n      \
    \    destinationReferences: ['REFERENCE']\n        },\n        { variable: 'TEST2',\
    \ value: 'AAAAAAAA' },\n        {\n          variable: 'TEST3',\n          value:\
    \ '123ABC',\n          destinationReferences: ['REFERENCE', 'REFERENCE2']\n  \
    \      }\n      ],\n      experimentalFields: [{ field: 'ABC', value: 'FOOBAR'\
    \ }]\n    }\n  ]\n});\n\nmock('sendHttpRequest', (requestUrl, requestOptions,\
    \ requestBody) => {\n  const parsedRequestBody = JSON.parse(requestBody);\n  assertThat(parsedRequestBody).isEqualTo({\n\
    \    validateOnly: false,\n    destinations: [\n      {\n        reference: 'productDestinationId',\n\
    \        productDestinationId: 'productDestinationId',\n        operatingAccount:\
    \ {\n          product: 'GOOGLE_ADS',\n          accountId: 'operatingAccountId'\n\
    \        },\n        linkedAccount: { product: 'GOOGLE_ADS', accountId: 'linkedAccountId'\
    \ }\n      },\n      {\n        reference: 'productDestinationId1',\n        productDestinationId:\
    \ 'productDestinationId1',\n        operatingAccount: {\n          product: 'GOOGLE_ADS',\n\
    \          accountId: 'operatingAccountId1'\n        },\n        linkedAccount:\
    \ { product: 'GOOGLE_ADS', accountId: 'linkedAccountId1' }\n      }\n    ],\n\
    \    consent: {\n      adUserData: 'CONSENT_GRANTED',\n      adPersonalization:\
    \ 'CONSENT_DENIED'\n    },\n    events: [\n      {\n        destionationReference:\
    \ 'productDestinationId1',\n        transactionId: 'Transaction ID 1',\n     \
    \   eventTimestamp: '2014-10-02T15:01:23Z',\n        lastUpdatedTimestamp: '2014-10-02T15:01:23Z',\n\
    \        currency: 'BRL',\n        conversionValue: 123.45,\n        eventSource:\
    \ 'WEB',\n        userData: {\n          userIdentifiers: [\n            {\n \
    \             emailAddress:\n                'ddffdce54594d729a13068951750239a1943c295a5f89349b5cf69744d4a1ba2'\n\
    \            },\n            {\n              phoneNumber:\n                'eec8f1a54d50ef04594e0fcc0414a49c186b31e3f820bfa2eb20dcc1ae9fcb67'\n\
    \            },\n            {\n              address: {\n                givenName:\n\
    \                  '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \                familyName:\n                  '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \                regionCode: 'US',\n                postalCode: '10001'\n    \
    \          }\n            }\n          ]\n        },\n        adIdentifiers: {\n\
    \          gclid: 'gclid',\n          gbraid: 'gbraid',\n          wbraid: 'wbraid',\n\
    \          landingPageDeviceInfo: {\n            userAgent: 'Landing Page User\
    \ Agent',\n            ipAddress: '1.1.1.1'\n          },\n          sessionAttributes:\
    \ 'Session Attributes'\n        },\n        eventDeviceInfo: { userAgent: 'User\
    \ Agent', ipAddress: '1.1.1.1' },\n        userProperties: { customerType: 'NEW',\
    \ customerValueBucket: 'LOW' },\n        cartData: {\n          merchantId: 'Merchant\
    \ Center ID',\n          merchantFeedLabel: 'Merchant Center Feed Label',\n  \
    \        merchantFeedLanguageCode: 'Merchant Center Feed Language Code',\n   \
    \       transactionDiscount: 123,\n          items: [\n            {\n       \
    \       merchantProductId: 'Merchant Product ID 1',\n              quantity: '1',\n\
    \              unitPrice: 123\n            },\n            {\n              merchantProductId:\
    \ 'Merchant Product ID 2',\n              quantity: '2',\n              unitPrice:\
    \ 111\n            }\n          ]\n        },\n        customVariables: [\n  \
    \        {\n            variable: 'TEST1',\n            value: 'ABC',\n      \
    \      destinationReferences: ['REFERENCE']\n          },\n          { variable:\
    \ 'TEST2', value: 'AAAAAAAA' },\n          {\n            variable: 'TEST3',\n\
    \            value: '123ABC',\n            destinationReferences: ['REFERENCE',\
    \ 'REFERENCE2']\n          }\n        ],\n        experimentalFields: [{ field:\
    \ 'ABC', value: 'FOOBAR' }]\n      },\n      {\n        transactionId: 'Transaction\
    \ ID 2',\n        eventTimestamp: '2014-10-02T15:01:23Z',\n        lastUpdatedTimestamp:\
    \ '2014-10-02T15:01:23Z',\n        currency: 'BRL',\n        conversionValue:\
    \ 1,\n        eventSource: 'WEB',\n        userData: {\n          userIdentifiers:\
    \ [\n            {\n              emailAddress:\n                '74790a65960d58724ba244c376e2bb6cbdd39f6c67d122760b319d51d11813a9'\n\
    \            },\n            {\n              phoneNumber:\n                '92effd108fc091e55b0239ffc94d867e649d45c28c3de6918ec1edcb0723602c'\n\
    \            },\n            {\n              address: {\n                givenName:\n\
    \                  '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \                familyName:\n                  '9f86d081884c7d659a2feaa0c55ad015a3bf4f1b2b0b822cd15d6c15b0f00a08',\n\
    \                regionCode: 'US',\n                postalCode: '10001'\n    \
    \          }\n            }\n          ]\n        },\n        adIdentifiers: {\n\
    \          gclid: 'gclid',\n          gbraid: 'gbraid',\n          wbraid: 'wbraid',\n\
    \          landingPageDeviceInfo: {\n            userAgent: 'Landing Page User\
    \ Agent',\n            ipAddress: '1.1.1.1'\n          },\n          sessionAttributes:\
    \ 'Session Attributes'\n        },\n        eventDeviceInfo: { userAgent: 'User\
    \ Agent', ipAddress: '1.1.1.1' },\n        userProperties: { customerType: 'NEW',\
    \ customerValueBucket: 'LOW' },\n        cartData: {\n          merchantId: 'Merchant\
    \ Center ID',\n          merchantFeedLabel: 'Merchant Center Feed Label',\n  \
    \        merchantFeedLanguageCode: 'Merchant Center Feed Language Code',\n   \
    \       transactionDiscount: 123,\n          items: [\n            {\n       \
    \       merchantProductId: 'Merchant Product ID 1',\n              quantity: '1',\n\
    \              unitPrice: 123\n            },\n            {\n              merchantProductId:\
    \ 'Merchant Product ID 2',\n              quantity: '2',\n              unitPrice:\
    \ 111\n            }\n          ]\n        },\n        customVariables: [\n  \
    \        {\n            variable: 'TEST1',\n            value: 'ABC',\n      \
    \      destinationReferences: ['REFERENCE']\n          },\n          { variable:\
    \ 'TEST2', value: 'AAAAAAAA' },\n          {\n            variable: 'TEST3',\n\
    \            value: '123ABC',\n            destinationReferences: ['REFERENCE',\
    \ 'REFERENCE2']\n          }\n        ],\n        experimentalFields: [{ field:\
    \ 'ABC', value: 'FOOBAR' }]\n      }\n    ],\n    encoding: 'HEX',\n    encryptionInfo:\
    \ {\n      gcpWrappedKeyInfo: {\n        keyType: 'XCHACHA20_POLY1305',\n    \
    \    wipProvider: '123',\n        kekUri: '123',\n        encryptedDek: '123'\n\
    \      }\n    }\n  });\n\n  return Promise.create((resolve, reject) => {\n   \
    \ resolve({ statusCode: 200 });\n  });  \n});\n\nrunCode(mockData);\n\ncallLater(()\
    \ => {\n  assertApi('gtmOnSuccess').wasCalled();\n  assertApi('gtmOnFailure').wasNotCalled();\n\
    });"
- name: '[Request] Should call gtmOnFailure when promise resolves and status code
    is outside success range'
  code: "setAllMockDataByAuthMethod('stape');\n\nmock('sendHttpRequest', (requestUrl,\
    \ requestOptions, requestBody) => {\n  return Promise.create((resolve, reject)\
    \ => {\n    resolve({ statusCode: 500 });\n  });  \n});\n\nrunCode(mockData);\n\
    \ncallLater(() => {\n  assertApi('gtmOnSuccess').wasNotCalled();\n  assertApi('gtmOnFailure').wasCalled();\n\
    });"
- name: '[Request] Should call gtmOnFailure when promise rejects'
  code: "setAllMockDataByAuthMethod('stape');\n\nmock('sendHttpRequest', (requestUrl,\
    \ requestOptions, requestBody) => {\n  return Promise.create((resolve, reject)\
    \ => {\n    reject({ reason: 'Failed' });\n  });  \n});\n\nrunCode(mockData);\n\
    \ncallLater(() => {\n  assertApi('gtmOnSuccess').wasNotCalled();\n  assertApi('gtmOnFailure').wasCalled();\n\
    });"
- name: '[Hex] Encoding is correctly defined when hashed User Data is already Hex
    encoded'
  code: "setGetAllEventData();\nsetAllMockDataByAuthMethod('stape', {\n  conversionEventMode:\
    \ 'single',\n  userDataEncoding: undefined,\n  autoMapUserData: false,\n  userDataEmailAddresses:\
    \ '426a1c28c61b7ba258fa3cc300ba7cd3abc11c0d4b585d3ce4a15d6f22d6d363',\n  userDataPhoneNumbers:\
    \ '426a1c28c61b7ba258fa3cc300ba7cd3abc11c0d4b585d3ce4a15d6f22d6d363',\n  addUserDataAddress:\
    \ true,\n  userDataAddressGivenName: '426a1c28c61b7ba258fa3cc300ba7cd3abc11c0d4b585d3ce4a15d6f22d6d363',\n\
    \  userDataAddressFamilyName: '426a1c28c61b7ba258fa3cc300ba7cd3abc11c0d4b585d3ce4a15d6f22d6d363',\n\
    \  userDataAddressRegion: '426a1c28c61b7ba258fa3cc300ba7cd3abc11c0d4b585d3ce4a15d6f22d6d363',\n\
    \  userDataAddressPostalCode: '426a1c28c61b7ba258fa3cc300ba7cd3abc11c0d4b585d3ce4a15d6f22d6d363',\n\
    });\n\nmock('sendHttpRequest', (requestUrl, requestOptions, requestBody) => {\n\
    \  const parsedRequestBody = JSON.parse(requestBody);\n  assertThat(parsedRequestBody.encoding).isEqualTo('HEX');\n\
    \n  return Promise.create((resolve, reject) => {\n    resolve({ statusCode: 200\
    \ });\n  });  \n});\n\nrunCode(mockData);\n\ncallLater(() => {\n  assertApi('gtmOnSuccess').wasCalled();\n\
    \  assertApi('gtmOnFailure').wasNotCalled();\n});"
- name: '[Base64] Encoding is correctly defined when hashed User Data is already Base64
    encoded'
  code: "setGetAllEventData();\nsetAllMockDataByAuthMethod('stape', {\n  conversionEventMode:\
    \ 'single',\n  userDataEncoding: undefined,\n  autoMapUserData: false,\n  userDataEmailAddresses:\
    \ 'osrifrM+43jsL6zoLw/I4luJ2T20MMOXTxBMsVIEx1o=',\n  userDataPhoneNumbers: 'osrifrM+43jsL6zoLw/I4luJ2T20MMOXTxBMsVIEx1o=',\n\
    \  addUserDataAddress: true,\n  userDataAddressGivenName: 'osrifrM+43jsL6zoLw/I4luJ2T20MMOXTxBMsVIEx1o=',\n\
    \  userDataAddressFamilyName: 'osrifrM+43jsL6zoLw/I4luJ2T20MMOXTxBMsVIEx1o=',\n\
    \  userDataAddressRegion: 'osrifrM+43jsL6zoLw/I4luJ2T20MMOXTxBMsVIEx1o=',\n  userDataAddressPostalCode:\
    \ 'osrifrM+43jsL6zoLw/I4luJ2T20MMOXTxBMsVIEx1o=',\n});\n\nmock('sendHttpRequest',\
    \ (requestUrl, requestOptions, requestBody) => {\n  const parsedRequestBody =\
    \ JSON.parse(requestBody);\n  assertThat(parsedRequestBody.encoding).isEqualTo('BASE64');\n\
    \n  return Promise.create((resolve, reject) => {\n    resolve({ statusCode: 200\
    \ });\n  });  \n});\n\nrunCode(mockData);\n\ncallLater(() => {\n  assertApi('gtmOnSuccess').wasCalled();\n\
    \  assertApi('gtmOnFailure').wasNotCalled();\n});"
- name: '[Logs] Should log to console'
  code: "const originalMockData = setAllMockDataByAuthMethod('stape');\n\n[\n  //\
    \ if the 'Always log to console' option is selected\n  { mockData: { logType:\
    \ 'always' }, expectedDebugMode: true },\n  // if the 'Log during debug and preview'\
    \ option is selected AND is on preview mode\n  { mockData: { logType: 'debug'\
    \ }, expectedDebugMode: true },\n].forEach(scenario => {\n  const copyMockData\
    \ = JSON.parse(JSON.stringify(originalMockData));\n  mergeObj(copyMockData, scenario.mockData);\n\
    \  \n  mock('getContainerVersion', () => {\n    return {\n      debugMode: scenario.expectedDebugMode\n\
    \    };\n  }); \n  \n  mock('logToConsole', (logData) => {\n    const parsedLogData\
    \ = JSON.parse(logData);\n    requiredConsoleKeys.forEach(p => assertThat(parsedLogData[p]).isDefined());\n\
    \  });\n  \n  runCode(copyMockData);\n  \n  callLater(() => {\n    assertApi('logToConsole').wasCalled();\n\
    \    assertApi('gtmOnSuccess').wasCalled();\n    assertApi('gtmOnFailure').wasNotCalled();\n\
    \  });\n});"
- name: '[Logs] Should NOT log to console'
  code: "const originalMockData = setAllMockDataByAuthMethod('stape');\n\n[\n  //\
    \ if the 'Log during debug and preview' option is selected AND is NOT on preview\
    \ mode\n  { mockData: { logType: 'debug' }, expectedDebugMode: false },\n  //\
    \ if the 'Do not log' option is selected\n  { mockData: { logType: 'no' }, expectedDebugMode:\
    \ undefined },\n].forEach(scenario => {\n  const copyMockData = JSON.parse(JSON.stringify(originalMockData));\n\
    \  mergeObj(copyMockData, scenario.mockData);\n  \n  mock('getContainerVersion',\
    \ () => {\n    return {\n      debugMode: scenario.expectedDebugMode\n    };\n\
    \  });\n  \n  runCode(copyMockData);\n\n  callLater(() => {\n    assertApi('logToConsole').wasNotCalled();\n\
    \    assertApi('gtmOnSuccess').wasCalled();\n    assertApi('gtmOnFailure').wasNotCalled();\n\
    \  });\n});"
- name: '[Logs] Should NOT log to BQ, if the ''Do not log to BigQuery'' option is
    selected'
  code: "setAllMockDataByAuthMethod('stape');\nmockData.bigQueryLogType = 'no';\n\n\
    // assertApi doesn't work for 'BigQuery.insert()'.\n// Ref: https://gtm-gear.com/posts/gtm-templates-testing/\n\
    mockObject('BigQuery', {\n  insert: (connectionInfo, rows, options) => { \n  \
    \  fail('BigQuery.insert should not have been called.');\n    return Promise.create((resolve,\
    \ reject) => {\n      resolve();\n    });\n  }\n});\n\nrunCode(mockData);\n\n\
    callLater(() => {\n  assertApi('gtmOnSuccess').wasCalled();\n  assertApi('gtmOnFailure').wasNotCalled();\n\
    });"
- name: '[Logs] Should log to BQ, if the ''Log to BigQuery'' option is selected'
  code: "setAllMockDataByAuthMethod('stape');\nmockData.bigQueryLogType = 'always';\n\
    \nmockObject('BigQuery', {\n  insert: (connectionInfo, rows, options) => { \n\
    \    assertThat(connectionInfo).isDefined();\n    assertThat(rows).isArray();\n\
    \    assertThat(rows).hasLength(1);\n    requiredBqKeys.forEach(p => assertThat(rows[0][p]).isDefined());\n\
    \    assertThat(options).isEqualTo(expectedBqOptions);\n    return Promise.create((resolve,\
    \ reject) => {\n      resolve();\n    });\n  }\n});\n\nrunCode(mockData);\n\n\
    callLater(() => {\n  assertApi('gtmOnSuccess').wasCalled();\n  assertApi('gtmOnFailure').wasNotCalled();\n\
    });"
setup: "const Promise = require('Promise');\nconst JSON = require('JSON');\nconst\
  \ makeInteger = require('makeInteger');\nconst Object = require('Object');\nconst\
  \ callLater = require('callLater');\n\nconst mergeObj = (target, source) => {\n\
  \  for (const key in source) {\n    if (source.hasOwnProperty(key)) target[key]\
  \ = source[key];\n  }\n  return target;\n};\n\nconst expectedBigQuerySettings =\
  \ {\n  logBigQueryProjectId: 'logBigQueryProjectId',\n  logBigQueryDatasetId: 'logBigQueryDatasetId',\n\
  \  logBigQueryTableId: 'logBigQueryTableId'\n};\n\nconst requiredConsoleKeys = ['Type',\
  \ 'TraceId', 'Name'];\nconst requiredBqKeys = ['timestamp', 'type', 'trace_id',\
  \ 'tag_name'];\nconst expectedBqOptions = { ignoreUnknownValues: true };\n\nconst\
  \ mockData = {\n  logBigQueryProjectId: expectedBigQuerySettings.logBigQueryProjectId,\n\
  \  logBigQueryDatasetId: expectedBigQuerySettings.logBigQueryDatasetId,\n  logBigQueryTableId:\
  \ expectedBigQuerySettings.logBigQueryTableId\n};\n\nconst setAllMockDataByAuthMethod\
  \ = (type, objToBeMerged) => {\n  const base = {\n    validateOnly: false,\n   \
  \ useOptimisticScenario: false,\n    \n    adUserData: 'CONSENT_GRANTED',\n    adPersonalization:\
  \ 'CONSENT_DENIED',\n    \n    userDataEncoding: 'HEX',\n    enableUserDataEncryption:\
  \ true,\n    gcpWrappedKeyType: 'XCHACHA20_POLY1305',\n    gcpWrappedKeyEncryptedDek:\
  \ '123',\n    gcpWrappedKeyKekUri: '123',\n    gcpWrappedKeyWipProvider: '123',\n\
  \    conversionEventMode: 'single',\n  \n    autoMapConversionInformation: true,\n\
  \    transactionId: 'Transaction ID',\n    eventTimestamp: '2014-10-02T15:01:23Z',\n\
  \    lastUpdatedTimestamp: '2014-10-02T15:01:23Z',\n    currency: 'BRL',\n    conversionValue:\
  \ '123.45',\n    eventSource: 'WEB',\n  \n    autoMapUserData: true,\n    userDataEmailAddresses:\
  \ 'google.google.google@gmail.com',\n    userDataPhoneNumbers: '55999999999',\n\
  \    addUserDataAddress: true,\n    userDataAddressGivenName: 'test',\n    userDataAddressFamilyName:\
  \ 'test',\n    userDataAddressRegion: 'US',\n    userDataAddressPostalCode: '10001',\n\
  \  \n    adIdentifiersGclid: 'gclid',\n    adIdentifiersGbraid: 'gbraid',\n    adIdentifiersWbraid:\
  \ 'wbraid',\n    adIdentifiersLandingPageDeviceInfoUserAgent: 'Landing Page User\
  \ Agent',\n    adIdentifiersLandingPageDeviceInfoIpAddress: '1.1.1.1',\n    adIdentifiersSessionAttributes:\
  \ 'Session Attributes',\n  \n    autoMapEventDeviceInfo: true,\n    eventDeviceInfoUserAgent:\
  \ 'User Agent',\n    eventDeviceInfoIpAddress: '1.1.1.1',\n  \n    userPropertiesCustomerType:\
  \ 'NEW',\n    userPropertiesCustomerValueBucket: 'LOW',\n  \n    autoMapCartData:\
  \ true,\n    itemIdKey: 'item_id',\n    cartDataMerchantId: 'Merchant Center ID',\n\
  \    cartDataMerchantFeedLabel: 'Merchant Center Feed Label',\n    cartDataMerchantFeedLanguageCode:\
  \ 'Merchant Center Feed Language Code',\n    cartDataTransactionDiscount: '123',\n\
  \    cartDataItems: [\n      { merchantProductId: 'Merchant Product ID 1', quantity:\
  \ '1', unitPrice: '123' },\n      { merchantProductId: 'Merchant Product ID 2',\
  \ quantity: '2', unitPrice: '111' }\n    ],\n  \n    customVariablesList: [\n  \
  \    { name: 'TEST1', value: 'ABC', destinationReferences: 'REFERENCE' },\n    \
  \  { name: 'TEST2', value: 'AAAAAAAA', destinationReferences: '' },\n      { name:\
  \ 'TEST3', value: '123ABC', destinationReferences: ['REFERENCE', 'REFERENCE2'] }\n\
  \    ],\n  \n    experimentalFieldsList: [{ name: 'ABC', value: 'FOOBAR' }],\n \
  \ \n    adStorageConsent: 'optional',\n    logType: 'debug',\n    bigQueryLogType:\
  \ 'no'\n  };\n  \n  const mockDataByAuthType = {\n    stape: {\n      authFlow:\
  \ 'stape',\n      stapeAuthDestinationsList: [\n        {\n          product: 'GOOGLE_ADS',\n\
  \          operatingAccountId: 'operatingAccountId',\n          linkedAccountId:\
  \ 'linkedAccountId',\n          productDestinationId: 'productDestinationId'\n \
  \       },\n        {\n          product: 'GOOGLE_ADS',\n          operatingAccountId:\
  \ 'operatingAccountId1',\n          linkedAccountId: 'linkedAccountId1',\n     \
  \     productDestinationId: 'productDestinationId1'\n        }\n      ]\n    },\n\
  \    own: {\n      authFlow: 'own',\n      ownAuthDestinationsList: [\n        {\n\
  \          product: 'GOOGLE_ADS',\n          operatingAccountId: 'operatingAccountId',\n\
  \          loginAccountId: 'loginAccountId',\n          productDestinationId: 'productDestinationId'\n\
  \        },\n        {\n          product: 'GOOGLE_ADS',\n          operatingAccountId:\
  \ 'operatingAccountId1',\n          loginAccountId: 'loginAccountId1',\n       \
  \   productDestinationId: 'productDestinationId1'\n        }\n      ]\n    }\n \
  \ };\n      \n  mergeObj(base, objToBeMerged || {});\n  mergeObj(mockDataByAuthType[type],\
  \ base);\n  mergeObj(mockData, mockDataByAuthType[type]);\n  return mockData;\n\
  };\n\nconst setGetAllEventData = (objToBeMerged) => {\n  mock('getAllEventData',\
  \ mergeObj({\n    'x-ga-protocol_version': '2',\n    'x-ga-measurement_id': 'G-123ABC',\n\
  \    'x-ga-gtm_version': '45je55e1za200',\n    'x-ga-page_id': 1747422523211,\n\
  \    'x-ga-gcd': '13l3l3l3l1l1',\n    'x-ga-npa': '0',\n    'x-ga-dma': '0',\n \
  \   'x-ga-mp2-tag_exp':\n      '101509157~103116025~103130498~103130500~103136993~103136995~103200001~103207802~103211513~103233427~103252644~103252646~103263073~103301114~103301116',\n\
  \    client_id: 'AUJctU7H7hBB/aMuhE4pKwGu5DWDdklg5abyyyn8i/I=.1747154479',\n   \
  \ 'x-ga-ecid': '1294673677',\n    language: 'en-us',\n    screen_resolution: '1512x982',\n\
  \    event_location: { country: 'BR', region: 'SP' },\n    event_id: '101509157~103116025~103130498',\n\
  \    timestamp: 1748377016,\n    client_hints: {\n      architecture: 'arm',\n \
  \     bitness: '64',\n      full_version_list: [\n        { brand: 'Chromium', version:\
  \ '136.0.7103.93' },\n        { brand: 'Google Chrome', version: '136.0.7103.93'\
  \ },\n        { brand: 'Not.A/Brand', version: '99.0.0.0' }\n      ],\n      mobile:\
  \ false,\n      model: '',\n      platform: 'macOS',\n      platform_version: '15.2.0',\n\
  \      wow64: false,\n      brands: [\n        { brand: 'Chromium', version: '136'\
  \ },\n        { brand: 'Google Chrome', version: '136' },\n        { brand: 'Not.A/Brand',\
  \ version: '99' }\n      ]\n    },\n    'x-ga-are': '1',\n    'x-ga-mp2-frm': '0',\n\
  \    'x-ga-pscdl': 'noapi',\n    'x-ga-system_properties': { eu: [34], tu: 'BA',\
  \ ss: '1', ee: true },\n    'x-sst-system_properties': {\n      etld: 'google.com.br',\n\
  \      tft: '1747422523211',\n      lpc: '60493049',\n      navt: 'r',\n      ude:\
  \ '0',\n      sw_exp: '1',\n      request_start_time_ms: 1747422524851\n    },\n\
  \    'x-ga-request_count': 1,\n    ga_session_id: '1747422523',\n    ga_session_number:\
  \ 3,\n    'x-ga-mp2-seg': '0',\n    page_location: 'https://example.com/?test=1i23i21j3',\n\
  \    page_title: 'Example Domain',\n    event_name: 'page_view',\n    'x-ga-tfd':\
  \ 5784,\n    ip_override: 'ip_override',\n    user_agent:\n      'user_agent',\n\
  \    value: 123.45,\n    currency: 'BRL',\n    user_data: {\n      email: { 0: 'test1@example.net',\
  \ 1: 'test2@example.org' },\n      phone_number: '+55 (19) 99999-9999',\n      address:\
  \ {\n        first_name: 'test',\n        last_name: 'test',\n        postal_code:\
  \ '10001',\n        country: 'BR'\n      }\n    },\n    transaction_id: 'transaction_id',\n\
  \    items: [\n      {\n        item_id: 'SKU_12345',\n        item_name: 'Stan\
  \ and Friends Tee',\n        affiliation: 'Google Merchandise Store',\n        coupon:\
  \ 'SUMMER_FUN',\n        discount: 2.22,\n        index: 0,\n        item_brand:\
  \ 'Google',\n        item_category: 'Apparel|iajsdiajsd|oasodiasd',\n        item_list_id:\
  \ 'related_products',\n        item_list_name: 'Related Products',\n        item_variant:\
  \ 'green',\n        location_id: 'ChIJIQBpAG2ahYAR_6128GcTUEo',\n        price:\
  \ 10.01,\n        quantity: 3,\n        item_group_id: 'abc'\n      },\n      {\n\
  \        item_id: 'SKU_12346',\n        item_name: \"Google Grey Women's (Tee)\"\
  ,\n        affiliation: 'Google Merchandise Store',\n        coupon: 'SUMMER_FUN',\n\
  \        discount: 3.33,\n        index: 1,\n        item_brand: 'Google',\n   \
  \     item_category: 'Apparel|iajsdiajsd|oasodiasd',\n        item_list_id: 'related_products',\n\
  \        item_list_name: 'Related Products',\n        item_variant: 'gray',\n  \
  \      location_id: 'ChIJIQBpAG2ahYAR_6128GcTUEo',\n        price: 21.01,\n    \
  \    promotion_id: 'P_12345',\n        promotion_name: 'Summer Sale',\n        quantity:\
  \ 2,\n        item_group_id: 'xyz'\n      }\n    ]\n  }, objToBeMerged || {}));\n\
  };\n\nmock('sendHttpRequest', (requestUrl, callback, requestOptions, requestBody)\
  \ => {\n  if (typeof callback === 'function') {\n    callback(200);\n  } else {\n\
  \    requestBody = requestOptions;\n    requestOptions = callback;\n    return Promise.create((resolve,\
  \ reject) => {\n      resolve({ statusCode: 200 });\n    });  \n  }\n});\n\nmock('getRequestHeader',\
  \ (header) => {\n  if (header === 'trace-id') return 'expectedTraceId';\n  else\
  \ if (header === 'x-gtm-identifier') return 'expectedXGtmIdentifier';\n  else if\
  \ (header === 'x-gtm-default-domain') return 'expectedXGtmDefaultDomain';\n  else\
  \ if (header === 'x-gtm-api-key') return 'expectedXGtmApiKey';\n});\n\nmock('getGoogleAuth',\
  \ 'googleAuthToken');\n\nmock('getTimestampMillis', 1747945830456);"


___NOTES___

Created on 7/9/2025, 6:32:40 PM

